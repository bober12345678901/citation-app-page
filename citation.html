<script>
    let penalCodesData = []; // Store penal codes fetched from backend

    document.addEventListener('DOMContentLoaded', async function() {
        // Check if user is logged in
        const token = sessionStorage.getItem('authToken');
        if (!token) {
            window.showCustomAlert("You must be logged in to submit a citation.", "Authentication Error").then(() => {
                sessionStorage.clear();
                window.location.href = 'index.html';
            });
            return;
        }

        const penalCodeInputsContainer = document.getElementById('penalCodeInputsContainer');
        const addPenalCodeBtn = document.getElementById('addPenalCodeBtn');
        const totalAmountDueSumInput = document.getElementById('totalAmountDueSum');
        const citationForm = document.getElementById('citationForm');
        const clearFormBtn = document.getElementById('clearFormBtn');
        const mainViolationTypeInput = document.getElementById('violationType'); // The main Violation Type field

        // --- Fetch Penal Codes on Load ---
        try {
            const response = await fetch('https://citation-app-worker.pnbober.workers.dev/penal-codes', { // Your Worker URL
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            if (response.ok) {
                penalCodesData = await response.json();
                console.log("Penal codes loaded:", penalCodesData);
            } else {
                const errorData = await response.json();
                console.error('Failed to load penal codes:', errorData.message);
                window.showCustomAlert('Warning: Could not load penal codes for auto-fill. ' + (errorData.message || response.statusText), 'Warning'); // Updated to use custom alert
            }
        } catch (error) {
            console.error('Network error loading penal codes:', error);
            window.showCustomAlert('Network error: Could not load penal codes for auto-fill.', 'Error'); // Updated to use custom alert
        }

        // --- Function to Add a New Penal Code Input Group ---
        function addPenalCodeGroup(initialCode = '', initialAmount = '0.00') {
            penalCodeGroupCounter++;
            const newGroupId = penalCodeGroupCounter;

            const newGroup = document.createElement('div');
            newGroup.classList.add('penal-code-group', 'grid', 'gap-x-6', 'gap-y-4', 'mb-4', 'items-end');
            newGroup.style.gridTemplateColumns = '1fr 1fr auto';
            newGroup.dataset.groupId = newGroupId;
            newGroup.innerHTML = `
                <div class="input-wrapper">
                    <label for="penalCode_${newGroupId}" class="theme-label block mb-2 font-medium">Penal Code:</label>
                    <input type="text" id="penalCode_${newGroupId}" name="penalCode_${newGroupId}" class="theme-input w-full p-2 border rounded-md penal-code-input" autocomplete="off">
                    <div id="penalCodeSuggestions_${newGroupId}" class="autocomplete-suggestions"></div>
                </div>
                <div class="amount-due-wrapper">
                    <label for="amountDue_${newGroupId}" class="theme-label block mb-2 font-medium">Amount Due:</label>
                    <input type="number" id="amountDue_${newGroupId}" name="amountDue_${newGroupId}" step="0.01" min="0" value="${initialAmount}" class="theme-input w-full p-2 border rounded-md amount-due-input" readonly>
                </div>
                <button type="button" class="theme-button-danger py-2 px-6 rounded-md font-semibold button-remove">Remove</button>
            `;
            penalCodeInputsContainer.appendChild(newGroup);

            setupAutocompleteForInput(newGroupId);
            newGroup.querySelector('.button-remove').addEventListener('click', function() {
                newGroup.remove();
                calculateTotalAmountDue();
                updateMainViolationType(); // Update main violation type after removal
            });

            calculateTotalAmountDue();
            updateMainViolationType(); // Update main violation type after adding
        }

        // --- Setup Autocomplete for a specific input group ---
        function setupAutocompleteForInput(groupId) {
            const penalCodeInput = document.getElementById(`penalCode_${groupId}`);
            const amountDueInput = document.getElementById(`amountDue_${groupId}`);
            const suggestionsDiv = document.getElementById(`penalCodeSuggestions_${groupId}`);

            penalCodeInput.addEventListener('input', function() {
                const query = this.value.toLowerCase();
                suggestionsDiv.innerHTML = '';
                suggestionsDiv.style.display = 'none';

                if (query.length > 0) {
                    const filteredCodes = penalCodesData.filter(pc =>
                        pc.code.toLowerCase().includes(query) || (pc.description && pc.description.toLowerCase().includes(query))
                    );
                    if (filteredCodes.length > 0) {
                        filteredCodes.forEach(pc => {
                            const suggestionItem = document.createElement('div');
                            // Display Offense Name and Type in suggestion
                            suggestionItem.textContent = `${pc.code} - ${pc.description || 'No description'} (${pc.type || 'N/A'})`;
                            suggestionItem.dataset.code = pc.code;
                            suggestionItem.dataset.amount = pc.amount_due;
                            suggestionItem.dataset.type = pc.type || '';
                            suggestionItem.dataset.description = pc.description || ''; // Store description in dataset
                            suggestionItem.dataset.jailTime = pc.jail_time_seconds || 0; // Store jail time
                            suggestionsDiv.appendChild(suggestionItem);

                            suggestionItem.addEventListener('click', function() {
                                penalCodeInput.value = this.dataset.code;
                                amountDueInput.value = parseFloat(this.dataset.amount).toFixed(2);
                                updateMainViolationType(); // Update main violation type after selection
                                suggestionsDiv.innerHTML = '';
                                suggestionsDiv.style.display = 'none';
                                calculateTotalAmountDue();
                            });
                        });
                        suggestionsDiv.style.display = 'block';
                    }
                }

                const matchedCode = penalCodesData.find(pc => pc.code.toLowerCase() === query);
                if (!matchedCode) {
                    amountDueInput.value = '0.00';
                } else {
                    amountDueInput.value = parseFloat(matchedCode.amount_due).toFixed(2);
                }
                calculateTotalAmountDue();
                updateMainViolationType(); // Update main violation type on input change
            });

            penalCodeInput.addEventListener('blur', () => {
                setTimeout(() => {
                    suggestionsDiv.style.display = 'none';
                }, 100);
                const exactMatch = penalCodesData.find(pc => pc.code.toLowerCase() === penalCodeInput.value.toLowerCase());
                if (exactMatch) {
                    amountDueInput.value = parseFloat(exactMatch.amount_due).toFixed(2);
                } else {
                    amountDueInput.value = '0.00';
                }
                calculateTotalAmountDue();
                updateMainViolationType(); // Update main violation type on blur
            });
            penalCodeInput.addEventListener('focus', () => {
                if (suggestionsDiv.innerHTML !== '' && penalCodeInput.value.length > 0) {
                    suggestionsDiv.style.display = 'block';
                }
            });
        }

        // --- Calculate Total Amount Due ---
        function calculateTotalAmountDue() {
            let total = 0;
            document.querySelectorAll('.amount-due-input').forEach(input => {
                const value = parseFloat(input.value);
                if (!isNaN(value)) {
                    total += value;
                }
            });
            totalAmountDueSumInput.value = `$${total.toFixed(2)}`;
        }

        // --- Update Main Violation Type based on all selected Penal Codes ---
        function updateMainViolationType() {
            const selectedDescriptions = [];
            document.querySelectorAll('.penal-code-input').forEach(input => {
                const code = input.value.trim();
                if (code) {
                    const matchedCode = penalCodesData.find(pc => pc.code.toLowerCase() === code.toLowerCase());
                    if (matchedCode && matchedCode.description) {
                        selectedDescriptions.push(matchedCode.description);
                    }
                }
            });
            mainViolationTypeInput.value = Array.from(new Set(selectedDescriptions)).join(', ');
            if (mainViolationTypeInput.value === '') {
                mainViolationTypeInput.placeholder = "Auto-filled from Penal Code(s)";
            } else {
                mainViolationTypeInput.placeholder = "";
            }
        }


        // --- Initial Setup ---
        setupAutocompleteForInput(0);
        addPenalCodeBtn.addEventListener('click', () => addPenalCodeGroup());
        calculateTotalAmountDue();
        updateMainViolationType(); // Initial call to set/clear main violation type

        // --- Form Clear Logic ---
        clearFormBtn.addEventListener('click', function() {
            window.showCustomConfirm("Are you sure you want to clear the form?", "Confirm Clear").then(confirmed => {
                if (confirmed) {
                    document.querySelectorAll('.penal-code-group[data-group-id]:not([data-group-id="0"])').forEach(group => group.remove());
                    document.getElementById('penalCode_0').value = '';
                    document.getElementById('amountDue_0').value = '0.00';
                    mainViolationTypeInput.value = '';
                    calculateTotalAmountDue();
                    updateMainViolationType(); // Update after clear
                }
            });
        });


        // --- Form Submission ---
        citationForm.addEventListener('submit', async function(event) {
            event.preventDefault();
            const form = event.target;

            const citationData = {};
            citationData.officerBadge = document.getElementById('officerBadge').value;
            citationData.officerName = document.getElementById('officerName').value;
            citationData.officerRank = document.getElementById('officerRank').value;
            citationData.violatorName = document.getElementById('violatorName').value;
            citationData.violationDetails = document.getElementById('violationDetails').value;
            citationData.violationType = mainViolationTypeInput.value;

            const appliedPenalCodes = [];
            let overallTotalAmount = 0;

            document.querySelectorAll('.penal-code-group').forEach(group => {
                const penalCodeInput = group.querySelector('.penal-code-input');
                const amountDueInput = group.querySelector('.amount-due-input');

                const code = penalCodeInput.value.trim();
                const amount = parseFloat(amountDueInput.value);

                if (code && !isNaN(amount)) {
                    const matchedCode = penalCodesData.find(pc => pc.code.toLowerCase() === code.toLowerCase());
                    appliedPenalCodes.push({
                        code: code,
                        description: matchedCode ? (matchedCode.description || 'N/A') : 'N/A',
                        amount: amount,
                        type: matchedCode ? (matchedCode.type || 'N/A') : 'N/A',
                        jail_time_seconds: matchedCode ? (matchedCode.jail_time_seconds || 0) : 0
                    });
                    overallTotalAmount += amount;
                }
            });

            citationData.appliedPenalCodes = appliedPenalCodes;
            citationData.totalAmountDue = overallTotalAmount;

            const token = sessionStorage.getItem('authToken');

            try {
                const response = await fetch('https://citation-app-worker.pnbober.workers.dev/submit-citation', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(citationData),
                });

                if (response.ok) {
                    const result = await response.json();
                    window.showCustomAlert(result.message, 'Success'); // Updated to use custom alert

                    sessionStorage.setItem('lastSubmittedCitation', JSON.stringify(citationData));
                    window.location.href = 'citation_display.html';
                } else if (response.status === 401 || response.status === 403) {
                    window.showCustomAlert("Authentication failed. Please log in again.", 'Error').then(() => {
                        sessionStorage.clear();
                        window.location.href = 'index.html';
                    });
                }
                else {
                    const errorData = await response.json();
                    window.showCustomAlert('Submission failed: ' + (errorData.message || response.statusText), 'Error'); // Updated to use custom alert
                }
            } catch (error) {
                console.error('Error:', error);
                window.showCustomAlert('An error occurred. Check console for details.', 'Error'); // Updated to use custom alert
            }
        });
    });
</script>