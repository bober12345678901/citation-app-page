<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" href="favicon.png" type="image/png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="styles.css">
    <script src="theme.js"></script>
    <style>
        /* Any custom overrides or specific element styles not covered by themes */
        /* These styles will apply regardless of the selected theme */
        a {
            text-decoration: none;
        }
        /* Specific styling for the user icon border */
        .user-icon-border {
            border-color: var(--text-color); /* Use theme's text color for border */
        }
        /* Custom styling for the N/A boxes to use theme variables */
        .theme-na-box {
            background-color: var(--input-bg-color); /* Using input-bg-color for inner boxes */
            border-color: var(--accent-color); /* Border color from accent */
        }
        /* Custom styling for section backgrounds to use theme variables */
        .theme-section-bg {
            background-color: var(--box-bg-color); /* Using box-bg-color for main sections */
        }
        /* Ensure specific text colors within statistics and warrants sections */
        .text-statistics-label {
            color: var(--text-color); /* Main text color for labels */
        }
        .text-na-value {
            color: var(--accent-color); /* Accent color for N/A values */
        }
        /* Loading indicator styling */
        .loading-text {
            text-align: center;
            padding: 1rem;
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--accent-color);
        }
        /* Custom scrollbar styling (optional, for aesthetics) */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: var(--box-bg-color);
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: var(--accent-color);
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: var(--button-primary-hover-bg);
        }

        /* Styles for the help categories (adapted from tutorials.html) */
        .help-category {
            margin-bottom: 1rem;
            padding: 0.5rem; /* Add some padding around each category box */
            border: 1px solid var(--border-color);
            border-radius: 0.3rem;
            background-color: color-mix(in srgb, var(--box-bg-color) 90%, var(--border-color)); /* Slightly different background */
        }
        .help-category h3 {
            font-weight: bold;
            font-size: 1.05em;
            margin-bottom: 0.4rem;
            color: var(--text-color);
            text-align: center;
        }
        .toggle-embed-group {
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 0.5rem;
            align-items: center;
        }
        .toggle-embed-group button {
             width: 90%;
             max-width: 200px;
             font-size: 0.85em;
             padding: 0.5rem 0.8rem;
             text-align: center;
             white-space: nowrap; /* Keep button text on a single line */
        }
        /* Fullscreen Embed Modal Styles (copied from tutorials.html) */
        #fullscreenEmbedModal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(0, 0, 0, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            transition: opacity 0.3s ease;
            opacity: 0;
            visibility: hidden;
        }
        #fullscreenEmbedModal.show {
			display: flex !important;
			opacity: 1;
			visibility: visible;
		}	
        #fullscreenEmbedContent {
            width: 90%;
            height: 90%;
            background-color: black;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        #fullscreenEmbedContent iframe,
        #fullscreenEmbedContent video {
            width: 100%;
            height: 100%;
            border: none;
            display: block;
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        #closeEmbedBtn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            font-size: 1.5em;
            color: white;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 5px;
        }
        #closeEmbedBtn:hover {
            background-color: rgba(255, 255, 255, 0.4);
        }
        /* Ensure modal buttons are flex items for proper spacing */
        #customModalButtons button {
            display: flex; /* Ensure buttons are always flex items */
            align-items: center;
            justify-content: center;
        }
        
        /* --- STYLES FOR AI HELP CHAT BOX --- */
        #chat-toggle {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            background-color: var(--accent-color); /* Uses theme color */
            color: var(--button-text-color);
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
            transition: transform 0.2s ease;
            z-index: 998; /* Below modals */
            border: none; /* Add this to remove default button border */
        }
        #chat-toggle:hover {
            transform: scale(1.1);
        }

        #chat-widget {
            position: fixed;
            bottom: 6rem;
            right: 1.5rem;
            width: 350px;
            max-width: 90vw;
            background-color: var(--box-bg-color); /* Uses theme color */
            border-radius: 0.5rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            border: 1px solid var(--border-color); /* Uses theme color */
            display: flex;
            flex-direction: column;
            overflow: hidden;
            z-index: 999; /* Below modals */
        }

        #chat-widget-header {
            padding: 0.75rem 1rem;
            background-color: var(--border-color); /* Darker header */
            color: var(--text-color);
            font-weight: 600;
        }

        #chat-messages {
            height: 300px;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            background-color: var(--input-bg-color); /* Uses theme color */
        }

        .chat-message {
            padding: 0.5rem 0.75rem;
            border-radius: 0.5rem;
            max-width: 80%;
            word-wrap: break-word;
        }

        .user-message {
            background-color: var(--accent-color); /* This is the theme's "button color" */
            color: var(--button-text-color);
            align-self: flex-end;
        }

        .bot-message {
            background-color: var(--button-secondary-bg); /* Lighter gray */
            color: var(--text-color);
            align-self: flex-start;
        }

        #chat-form {
            display: flex;
            border-top: 1px solid var(--border-color); /* Uses theme color */
            padding: 0.5rem;
        }
        #chat-input {
            flex-grow: 1;
            border: none;
            background-color: var(--input-bg-color); /* Uses theme color */
            color: var(--text-color);
            padding: 0.5rem;
        }
        #chat-input:focus {
            outline: none;
        }
        #chat-send-btn {
            /* Uses theme-button-primary class */
            padding: 0.5rem 1rem;
            font-weight: 600;
            border: none;
            border-radius: 0.375rem;
            margin-left: 0.5rem;
        }

        /* --- STYLES FOR TYPING INDICATOR --- */
        .typing-indicator {
            padding: 0.5rem 0.75rem;
            border-radius: 0.5rem;
            background-color: var(--button-secondary-bg); /* Same as bot-message */
            color: var(--text-color);
            align-self: flex-start;
            display: inline-block;
        }
        .typing-indicator span {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: var(--text-color);
            opacity: 0.4;
            margin: 0 2px;
            animation: pulse 1.4s infinite alternate;
        }
        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }
        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }
        @keyframes pulse {
            0% {
                opacity: 0.4;
                transform: scale(0.8);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }
    </style>
</head>
<body class="min-h-screen theme-app-container flex items-center justify-center p-4">
    <div class="container mx-auto max-w-6xl w-full rounded-lg shadow-lg p-6 md:p-8 theme-lookup-box">

        <header class="flex flex-col sm:flex-row items-center justify-between mb-8 pb-4 border-b border-gray-700">
            <div class="flex items-center space-x-4 mb-4 sm:mb-0">
                <div class="w-16 h-16 rounded-full border-2 user-icon-border flex items-center justify-center flex-shrink-0">
                    <svg class="w-10 h-10 theme-label" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                    </svg>
                </div>
                <div>
                    <h1 id="welcomeText" class="text-3xl font-bold theme-title">Welcome, Officer</h1>
                    <p id="badgeNumber" class="text-lg theme-label">Badge: N/A</p>
                    <p id="departmentName" class="text-lg theme-label"></p> </div>
            </div>
            <div class="flex space-x-4">
                <button id="adminButton" class="px-6 py-2 rounded-lg font-semibold shadow-md transition-colors hidden theme-button-danger">Admin</button>
                <button id="leaderboardButton" class="px-6 py-2 rounded-lg font-semibold shadow-md transition-colors hidden theme-button-secondary">Leaderboards</button>
                <button id="logoutButton" class="px-6 py-2 rounded-lg font-semibold shadow-md transition-colors theme-button-secondary">Log Out</button>
            </div>
        </header>

        <div class="mb-6 flex justify-end items-center">
            <label for="themeSelector" class="theme-label flex items-center font-medium mr-2">Theme:</label>
            <select id="themeSelector" class="theme-input p-2 border rounded-md transition-colors duration-200">
                <option value="light">Light</option>
                <option value="dark">Dark</option>
                <option value="sunset">Sunset</option>
                <option value="ocean">Ocean</option>
                <option value="forest">Forest</option>
                <option value="midnight">Midnight</option>
                <option value="dracula">Dracula</option>
                <option value="cyberpunk">Cyberpunk</option>
                <option value="custom">Custom...</option>
            </select>
            <div id="customColorsContainer" class="hidden mt-4 ml-4 flex flex-col space-y-2">
                <div>
                    <label for="customBgColor" class="theme-label block mb-1">Background Color:</label>
                    <input type="color" id="customBgColor" value="#f3f4f6" class="w-full h-8 p-0 border rounded-md cursor-pointer theme-input" />
                </div>
                <div>
                    <label for="customTextColor" class="theme-label block mb-1">Text Color:</label>
                    <input type="color" id="customTextColor" value="#1f2937" class="w-full h-8 p-0 border rounded-md cursor-pointer theme-input" />
                </div>
                <div>
                    <label for="customAccentColor" class="theme-label block mb-1">Accent Color:</label>
                    <input type="color" id="customAccentColor" value="#3b82f6" class="w-full h-8 p-0 border rounded-md cursor-pointer theme-input" />
                </div>
            </div>
        </div>

        <main class="grid grid-cols-1 md:grid-cols-3 gap-8">

            <section class="p-6 rounded-lg shadow-md theme-section-bg flex flex-col">
                <h2 class="text-xl font-semibold mb-4 text-statistics-label">Your Statistics:</h2>
                <div id="statisticsLoadingIndicator" class="loading-text hidden">Loading statistics...</div>
                <div id="statisticsContent" class="space-y-4 flex-grow flex flex-col justify-center">
                    <div class="p-4 rounded-lg text-center shadow-inner theme-na-box">
                        <p id="citationCount" class="text-4xl font-bold text-na-value">N/A</p>
                        <p class="text-statistics-label">Citations Filled</p>
                    </div>
                    <div class="p-4 rounded-lg text-center shadow-inner theme-na-box">
                        <p id="shiftCount" class="text-4xl font-bold text-na-value">N/A</p>
                        <p class="text-statistics-label">Shifts Logged</p>
                    </div>
                </div>
            </section>

            <section class="p-6 rounded-lg shadow-md flex flex-col justify-center space-y-6 theme-section-bg">
                <button id="openCitationLogBtn" class="px-8 py-4 rounded-lg font-bold text-xl shadow-lg transition-colors border border-white theme-button-primary">Open Citation Log</button>
                <button id="openArrestLogBtn" class="px-8 py-4 rounded-lg font-bold text-xl shadow-lg transition-colors border border-white theme-button-primary">Open Arrest Log</button>
                <button id="openShiftLogBtn" class="px-8 py-4 rounded-lg font-bold text-xl shadow-lg transition-colors border border-white theme-button-primary">Open Shift Log</button>
            </section>

            <section class="p-6 rounded-lg shadow-md theme-section-bg">
                <h2 class="text-xl font-semibold mb-4 text-statistics-label">Help Desk:</h2>
                <div class="max-h-72 overflow-y-auto custom-scrollbar">
                    <p class="theme-label mb-4">
                        Find step-by-step guides and video tutorials for using the application's forms.
                    </p>

                    <div class="grid grid-cols-1 gap-4">
                        <div class="help-category">
                            <h3>Citations</h3>
                            <div class="toggle-embed-group">
                                <button class="theme-button-secondary toggle-embed-btn" data-embed-type="pdf" data-url="/cite/citations_step_by_step.pdf">Open PDF Guide</button>
                                <button class="theme-button-secondary toggle-embed-btn" data-embed-type="video" data-url="/cite/citations_video.mp4">Open Video Guide</button>
                            </div>
                        </div>

                        <div class="help-category">
                            <h3>Arrests</h3>
                            <div class="toggle-embed-group">
                                <button class="theme-button-secondary toggle-embed-btn" data-embed-type="pdf" data-url="/arrest no warrant/arrests_step_by_step.pdf">Open PDF Guide</button>
                                <button class="theme-button-secondary toggle-embed-btn" data-embed-type="video" data-url="/arrest no warrant/arrests_video.mp4">Open Video Guide</button>
                            </div>
                        </div>
                    </div>

                    <div class="help-category mx-auto mt-4" style="max-width: 250px;">
                        <h3>Arrests w/ Warrants</h3>
                        <div class="toggle-embed-group">
                            <button class="theme-button-secondary toggle-embed-btn" data-embed-type="pdf" data-url="/arrest w warrant/arrests_w_warrants_step_by_step.pdf">Open PDF Guide</button>
                            <button class="theme-button-secondary toggle-embed-btn" data-embed-type="video" data-url="/arrest w warrant/arrests_w_warrants_video.mp4">Open Video Guide</button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

        </main>
    </div>

    <div id="fullscreenEmbedModal" class="hidden">
        <button id="closeEmbedBtn">X</button>
        <div id="fullscreenEmbedContent">
        </div>
    </div>

    <div id="customModalOverlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div id="customModal" class="theme-lookup-box p-6 rounded-lg shadow-xl max-w-sm w-full mx-4 sm:mx-auto">
            <h3 id="customModalTitle" class="theme-title text-xl font-bold mb-4"></h3>
            <p id="customModalMessage" class="theme-label mb-6"></p>
            <div id="customModalButtons" class="flex justify-end space-x-3">
                <button id="customModalCancelBtn" class="theme-button-secondary py-2 px-4 rounded-md font-semibold hidden">Cancel</button>
                <button id="customModalOkBtn" class="theme-button-primary py-2 px-4 rounded-md font-semibold">OK</button>
            </div>
        </div>
    </div>

    <button id="chat-toggle" title="Open AI Help" type="button">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-8 h-8 pointer-events-none">
            <path stroke-linecap="round" stroke-linejoin="round" d="M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025 1.172 2.687 0 3.712-.203.179-.43.326-.67.442-.745.361-1.45.999-1.45 1.827v.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 5.25h.008v.008H12v-.008Z" />
        </svg>          
    </button>
    <div id="chat-widget" class="hidden">
        <div id="chat-widget-header">
            AI Help Bot
        </div>
        <div id="chat-messages" class="custom-scrollbar"> <div class="chat-message bot-message">
                Hello! How can I not help you?
            </div>
        </div>
        <form id="chat-form">
            <input type="text" id="chat-input" placeholder="Ask a question..." autocomplete="off">
            <button type="submit" id="chat-send-btn" class="theme-button-primary">Send</button>
        </form>
    </div>
    <script>
        // Custom alert and confirm functions are now exclusively defined in theme.js.
        // This script will call those functions.

        document.addEventListener('DOMContentLoaded', async function() {
            const token = sessionStorage.getItem('authToken');
            const userInfoString = sessionStorage.getItem('loggedInUser');
            let userInfo = null;

            if (userInfoString) {
                userInfo = JSON.parse(userInfoString);
            }

            const welcomeText = document.getElementById('welcomeText');
            const badgeNumberDisplay = document.getElementById('badgeNumber');
            const departmentNameDisplay = document.getElementById('departmentName'); // Get the new department element
            const logoutButton = document.getElementById('logoutButton');
            const adminButton = document.getElementById('adminButton');
            const leaderboardButton = document.getElementById('leaderboardButton'); // Get new leaderboard button

            const openCitationLogBtn = document.getElementById('openCitationLogBtn');
            const openArrestLogBtn = document.getElementById('openArrestLogBtn');
            const openShiftLogBtn = document.getElementById('openShiftLogBtn');

            const citationCountElement = document.getElementById('citationCount');
            const shiftCountElement = document.getElementById('shiftCount');
            const statisticsLoadingIndicator = document.getElementById('statisticsLoadingIndicator');
            const statisticsContent = document.getElementById('statisticsContent');

            // Help Desk specific elements
            const fullscreenEmbedModal = document.getElementById('fullscreenEmbedModal');
            const fullscreenEmbedContent = document.getElementById('fullscreenEmbedContent');
            const closeEmbedBtn = document.getElementById('closeEmbedBtn');
            // Check the R2_BASE_URL: This must point to the root of your tutorials folder in R2
            // Example: 'https://pub-YOUR_ACCOUNT_ID.r2.dev/YOUR_BUCKET_NAME/tutorials'
            const R2_BASE_URL = 'https://pub-a91d9d22a6264a88b02227540eadf4cb.r2.dev/tutorials'; 

            // Authentication check
            if (!token || !userInfo) {
                // Use the showCustomAlert from theme.js
                window.showCustomAlert("You must be logged in to access this page.", "Error", "Authentication Error").then(() => {
                    sessionStorage.clear();
                    window.location.href = 'index.html';
                });
                return;
            } else {
                welcomeText.textContent = `Welcome, Officer ${userInfo.username}`;
                badgeNumberDisplay.textContent = `Badge: ${userInfo.badgeNumber}`;
                // Display the department name
                departmentNameDisplay.textContent = `Department: ${userInfo.department || 'N/A'}`;


                // Conditional display for Admin and Leaderboard buttons
                if (userInfo.role === 'admin') {
                    adminButton.classList.remove('hidden'); // Show Admin button
                    leaderboardButton.classList.remove('hidden'); // Show Leaderboard button for admin
                } else {
                    adminButton.classList.add('hidden'); // Hide Admin button for normal users
                    leaderboardButton.classList.remove('hidden'); // Show Leaderboard button for normal users
                }
            }

            // Function to fetch and display statistics counts (Citations and Shifts)
            async function fetchAndDisplayCounts() {
                statisticsLoadingIndicator.classList.remove('hidden');
                statisticsContent.classList.add('hidden');

                let citationCount = 0;
                let shiftCount = 0;
                let citationsData = []; // Declare at top
                let shiftLogsData = []; // Declare at top

                // --- NEW: Check for cached data ---
                const cachedStats = sessionStorage.getItem('userStats');
                if (cachedStats) {
                    try {
                        const parsedStats = JSON.parse(cachedStats);
                        // Check if the cached data is for the current user (important for multi-user scenarios)
                        if (parsedStats.username === userInfo.username && parsedStats.badgeNumber === userInfo.badgeNumber) {
                            citationCount = parsedStats.citationCount;
                            shiftCount = parsedStats.shiftCount;
                            citationCountElement.textContent = citationCount;
                            shiftCountElement.textContent = shiftCount;
                            console.log("Statistics loaded from cache.");
                            statisticsLoadingIndicator.classList.add('hidden');
                            statisticsContent.classList.remove('hidden');
                            return; // Exit if cached data is used
                        }
                    } catch (e) {
                        console.error("Error parsing cached stats:", e);
                        sessionStorage.removeItem('userStats'); // Clear corrupted cache
                    }
                }
                // --- END NEW ---

                try {
                    // ðŸ”‘ FIX: Define headers correctly with the token and content type
                    const headers = { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}` 
                    };
                    const workerBaseUrl = 'https://citation-app-worker.pnbober.workers.dev'; // Your Cloudflare Worker URL

                    // Fetch Citations
                    // âœ… CORRECTED: Reverted path back to /citations to match the working Worker route
                    const citationsResponse = await fetch(`${workerBaseUrl}/citations`, { headers });
                    if (citationsResponse.ok) {
                        citationsData = await citationsResponse.json();
                        // Client-side filter for the logged-in user's citations
                        const loggedInUsernameLower = userInfo.username.toLowerCase();
                        const userCitations = citationsData.filter(c => c.submittedBy && c.submittedBy.toLowerCase() === loggedInUsernameLower);
                        citationCount = userCitations.length;
                        citationCountElement.textContent = citationCount;
                    } else {
                        const errorData = await citationsResponse.json().catch(() => ({ message: 'Could not parse error response.' }));
                        // Use the showCustomAlert from theme.js
                        window.showCustomAlert('Failed to load citation data: ' + (errorData.message || citationsResponse.statusText), 'Error', 'Data Load Error');
                        citationCountElement.textContent = 'N/A';
                    }

                    // Fetch Shift Logs
                    // ðŸ”‘ FIX: Changed path from /shift-logs to /get/shift-logs to match worker routing
                    const shiftLogsResponse = await fetch(`${workerBaseUrl}/shift-logs`, { headers });
                    if (shiftLogsResponse.ok) {
                        shiftLogsData = await shiftLogsResponse.json(); // Assign to already declared variable
                        // Client-side filter for the logged-in user's shift logs
                        const loggedInUsernameLower = userInfo.username.toLowerCase();
                        const userShiftLogs = shiftLogsData.filter(s => s.submittedByUsername && s.submittedByUsername.toLowerCase() === loggedInUsernameLower);
                        shiftCount = userShiftLogs.length;
                        shiftCountElement.textContent = shiftCount;
                    } else {
                        const errorData = await shiftLogsResponse.json().catch(() => ({ message: 'Could not parse error response.' }));
                        // Use the showCustomAlert from theme.js
                        window.showCustomAlert('Failed to load shift log data: ' + (errorData.message || shiftLogsResponse.statusText), 'Error', 'Data Load Error');
                        shiftCountElement.textContent = 'N/A';
                    }

                    // --- NEW: Save fetched data to cache ---
                    const statsToCache = {
                        username: userInfo.username,
                        badgeNumber: userInfo.badgeNumber,
                        citationCount: citationCount,
                        shiftCount: shiftCount
                    };
                    sessionStorage.setItem('userStats', JSON.stringify(statsToCache));
                    console.log("Statistics saved to cache.");
                    // --- END NEW ---

                } catch (error) {
                    console.error('Network error fetching statistics:', error);
                    // Use the showCustomAlert from theme.js
                    window.showCustomAlert('Network error: Could not load statistics. Check console for details.', 'Error', 'Network Error');
                    citationCountElement.textContent = 'N/A';
                    shiftCountElement.textContent = 'N/A';
                } finally {
                    statisticsLoadingIndicator.classList.add('hidden');
                    statisticsContent.classList.remove('hidden');
                }
            }

            // Call the function to fetch and display data when the page loads
            fetchAndDisplayCounts();

            // Logout Functionality
            logoutButton.addEventListener('click', function(event) {
                event.preventDefault();
                // Use window.showCustomConfirm from theme.js for Yes/No
                window.showCustomConfirm("Are you sure you want to log out?", "Confirm Logout").then((confirmed) => {
                    if (confirmed) {
                        sessionStorage.clear(); // Clear all session data
                        window.location.href = 'index.html'; // Redirect to login
                    }
                });
            });

            // Navigation for the action buttons
            openCitationLogBtn.addEventListener('click', function() {
                window.location.href = 'citation.html';
            });

            openArrestLogBtn.addEventListener('click', function() {
                window.location.href = 'arrest.html';
            });

            openShiftLogBtn.addEventListener('click', function() {
                window.location.href = 'shift_log.html';
            });

            // Admin button navigation
            adminButton.addEventListener('click', function() {
                window.location.href = 'admin.html';
            });

            // Leaderboard button navigation
            leaderboardButton.addEventListener('click', function() {
                window.location.href = 'leaderboard.html';
            });

            // --- Help Desk Embed Modal Functionality (from tutorials.html) ---
            document.querySelectorAll('.toggle-embed-btn').forEach(button => {
                button.addEventListener('click', function () {
                    const embedType = this.dataset.embedType;
                    const relativeUrl = this.dataset.url;

                    // Ensure fullscreenEmbedContent is not null before proceeding
                    if (!fullscreenEmbedContent) {
                        console.error("Error: fullscreenEmbedContent element not found.");
                        window.showCustomAlert("An internal error occurred. Please try again.", "Error");
                        return;
                    }

                    fullscreenEmbedContent.innerHTML = ''; // Clear previous content

                    if (embedType === 'pdf') {
                        const embed = document.createElement('embed');
                        embed.src = R2_BASE_URL + relativeUrl;
                        embed.type = 'application/pdf';
                        embed.style.width = '100%';
                        embed.style.height = '100%';
                        fullscreenEmbedContent.appendChild(embed);
                    } else if (embedType === 'video') {
                        const video = document.createElement('video');
                        video.controls = true;
                        video.autoplay = true;
                        video.preload = 'auto';
                        video.setAttribute('allowfullscreen', '');
                        const source = document.createElement('source');
                        source.src = R2_BASE_URL + relativeUrl;
                        source.type = relativeUrl.includes('.mp4') ? 'video/mp4' : ''; // Infer type for video
                        video.appendChild(source);
                        fullscreenEmbedContent.appendChild(video); // Append the video element
                    }

                    // Ensure fullscreenEmbedModal is not null before showing
                    if (fullscreenEmbedModal) {
                        fullscreenEmbedModal.classList.add('show');
                    } else {
                        console.error("Error: fullscreenEmbedModal element not found.");
                        window.showCustomAlert("An internal error occurred. Please try again.", "Error");
                    }
                });
            });

            function closeFullscreenEmbedModal() {
                // Ensure fullscreenEmbedModal is not null before proceeding
                if (!fullscreenEmbedModal) return;

                fullscreenEmbedModal.classList.remove('show');
                const videoElement = fullscreenEmbedContent.querySelector('video');
                if (videoElement) videoElement.pause(); // Pause video when closing
                // Clear content after transition for smoother experience
                setTimeout(() => {
                    // Ensure fullscreenEmbedContent is not null before clearing
                    if (fullscreenEmbedContent) fullscreenEmbedContent.innerHTML = '';
                }, 300);
            }

            // Ensure closeEmbedBtn is not null before attaching listener
            if (closeEmbedBtn) {
                closeEmbedBtn.addEventListener('click', closeFullscreenEmbedModal);
            } else {
                console.error("Error: closeEmbedBtn element not found.");
            }

            // Close modal on Escape key
            document.addEventListener('keydown', function(event) {
                if (event.key === 'Escape' && fullscreenEmbedModal && fullscreenEmbedModal.classList.contains('show')) {
                    closeFullscreenEmbedModal();
                }
            });

            // Close modal on outside click
            document.addEventListener('click', function(event) {
                if (event.target === fullscreenEmbedModal && fullscreenEmbedModal) {
                    closeFullscreenEmbedModal();
                }
            });
            // --- End Help Desk Embed Modal Functionality ---


            // --- UPDATED: AI CHAT BOX SCRIPT ---
            const chatToggle = document.getElementById('chat-toggle');
            const chatWidget = document.getElementById('chat-widget');
            const chatForm = document.getElementById('chat-form');
            const chatInput = document.getElementById('chat-input');
            const chatMessages = document.getElementById('chat-messages');

const botResponses = [
    "What?",
    "Refresh the website.",
    "I don't know.",
    "Can you ask a question regarding the website please?",
    "Sorry, I am not programmed to help with that.",
    "Interesting... Iâ€™ll pretend I understood that.",
    "Try turning your monitor off and on again.",
    "Hmm... that sounds like a you problem.",
    "My last brain cell just left the chat.",
    "Thatâ€™s above my pay grade.",
    "Have you tried asking Google?",
    "I forgot.",
    "Hold on, Iâ€™ll ask my supervisor",
    "Good question! Unfortunately, I wasnâ€™t listening.",
    "Great question, but Iâ€™m just here for decoration."
];

// Greeting keywords and responses
const greetings = ["hi", "hello", "hey", "yo", "sup", "howdy", "greetings"];
const greetingResponses = [
    "Hello!",
    "Hi there!",
    "Hey hey!",
    "Greetings, human!",
    "Howdy partner!",
    "Hey! Need some unhelpful assistance?"
];

// Profanity filter and angry replies
const profanities = [
  "abbo", "abo", "abortion", "abuse", "addict", "addicts", "adult", "africa", "african", "alla",
  "allah", "alligatorbait", "amateur", "american", "anal", "analannie", "analsex", "angry",
  "anus", "arab", "arabs", "areola", "argie", "aroused", "arse", "arsehole", "asian", "ass",
  "assassin", "assassinate", "assassination", "assault", "assbagger", "assblaster", "assclown",
  "asscowboy", "asses", "assfuck", "assfucker", "asshat", "asshole", "assholes", "asshore",
  "assjockey", "asskiss", "asskisser", "assklown", "asslick", "asslicker", "asslover", "assman",
  "assmonkey", "assmunch", "assmuncher", "asspacker", "asspirate", "asspuppies", "assranger",
  "asswhore", "asswipe", "athletesfoot", "attack", "australian", "babe", "babies", "backdoor",
  "backdoorman", "backseat", "badfuck", "balllicker", "balls", "ballsack", "banging", "baptist",
  "barelylegal", "barf", "barface", "barfface", "bast", "bastard", "bazongas", "bazooms", "beaner",
  "beast", "beastality", "beastial", "beastiality", "beatoff", "beat-off", "beatyourmeat", "beaver",
  "bestial", "bestiality", "bi", "biatch", "bible", "bicurious", "bigass", "bigbastard", "bigbutt",
  "bigger", "bisexual", "bi-sexual", "bitch", "bitcher", "bitches", "bitchez", "bitchin", "bitching",
  "bitchslap", "bitchy", "biteme", "black", "blackman", "blackout", "blacks", "blow", "blowjob",
  "boang", "bogan", "bohunk", "bollick", "bollock", "bomb", "bombers", "bombing", "bombs", "bomd",
  "bondage", "boner", "bong", "boob", "boobies", "boobs", "booby", "boody", "boom", "boong",
  "boonga", "boonie", "booty", "bootycall", "bountybar", "bra", "brea5t", "breast", "breastjob",
  "breastlover", "breastman", "brothel", "bugger", "buggered", "buggery", "bullcrap", "bulldike",
  "bulldyke", "bullshit", "bumblefuck", "bumfuck", "bunga", "bunghole", "butchbabes", "butchdike",
  "butchdyke", "butt", "buttbang", "butt-bang", "buttface", "buttfuck", "butt-fuck", "buttfucker",
  "butt-fuckers", "butthead", "buttman", "buttmunch", "buttmuncher", "buttpirate", "buttplug",
  "buttstain", "byatch", "cacker", "cameljockey", "cameltoe", "canadian", "cancer", "carpetmuncher",
  "carruth", "catholic", "catholics", "cemetery", "chav", "cherrypopper", "chickslick", "chin",
  "chinaman", "chinamen", "chinese", "chink", "chinky", "choad", "chode", "christ", "christian",
  "church", "cigarette", "cigs", "clamdigger", "clamdiver", "clit", "clitoris", "clogwog", "cocaine",
  "cock", "cockblock", "cockblocker", "cockcowboy", "cockfight", "cockhead", "cockknob",
  "cocklicker", "cocklover", "cocknob", "cockqueen", "cockrider", "cocksman", "cocksmith",
  "cocksmoker", "cocksucer", "cocksuck", "cocksucked", "cocksucker", "cocksucking", "cocktail",
  "cocktease", "cocky", "cohee", "coitus", "color", "colored", "coloured", "commie", "communist",
  "condom", "conservative", "conspiracy", "coolie", "cooly", "coon", "coondog", "copulate",
  "cornhole", "corruption", "cra5h", "crabs", "crack", "crackpipe", "crackwhore", "crack-whore",
  "crap", "crapola", "crapper", "crappy", "creamy", "crime", "crimes", "criminal", "criminals",
  "crotch", "crotchjockey", "crotchmonkey", "crotchrot", "cum", "cumbubble", "cumfest", "cumjockey",
  "cumm", "cummer", "cumming", "cumquat", "cumqueen", "cumshot", "cunilingus", "cunillingus",
  "cunn", "cunnilingus", "cunntt", "cunt", "cunteyed", "cuntfuck", "cuntfucker", "cuntlick",
  "cuntlicker", "cuntlicking", "cuntsucker", "cybersex", "cyberslimer", "dago", "dahmer", "dammit",
  "damn", "damnation", "damnit", "darkie", "darky", "datnigga", "dead", "deapthroat", "death",
  "deepthroat", "defecate", "dego", "demon", "deposit", "desire", "destroy", "deth", "devil",
  "devilworshipper", "dick", "dickbrain", "dickforbrains", "dickhead", "dickless", "dicklick",
  "dicklicker", "dickman", "dickwad", "dickweed", "diddle", "die", "died", "dies", "dike", "dildo",
  "dingleberry", "dink", "dipshit", "dipstick", "dirty", "disease", "diseases", "disturbed", "dive",
  "dix", "dixiedike", "dixiedyke", "doggiestyle", "doggystyle", "dong", "doodoo", "doo-doo", "dope",
  "dragqueen", "dragqween", "dripdick", "drug", "drunk", "drunken", "dumb", "dumbass", "dumbbitch",
  "dumbfuck", "dyefly", "dyke", "easyslut", "eatballs", "eatme", "eatpussy", "ecstacy", "ejaculate",
  "ejaculated", "ejaculating", "ejaculation", "enema", "enemy", "erect", "erection", "ero", "escort",
  "ethiopian", "ethnic", "european", "evl", "excrement", "execute", "executed", "execution",
  "executioner", "explosion", "facefucker", "faeces", "fag", "fagging", "faggot", "fagot", "failed",
  "failure", "fairies", "fairy", "faith", "fannyfucker", "fart", "farted", "farting", "farty",
  "fastfuck", "fat", "fatah", "fatass", "fatfuck", "fatfucker", "fatso", "fckcum", "fear", "feces",
  "felatio", "felch", "felcher", "felching", "fellatio", "feltch", "feltcher", "feltching", "fetish",
  "fight", "filipina", "filipino", "fingerfood", "fingerfuck", "fingerfucked", "fingerfucker",
  "fingerfuckers", "fingerfucking", "fister", "fistfuck", "fistfucked", "fistfucker", "fistfucking",
  "fisting", "flange", "flasher", "flatulence", "floo", "flydie", "flydye", "fok", "fondle",
  "footaction", "footfuck", "footfucker", "footlicker", "footstar", "foreskin", "forni", "fornicate",
  "foursome", "fourtwenty", "fraud", "freakfuck", "freakyfucker", "freefuck", "fu", "fubar", "fuc",
  "fucck", "fuck", "fucka", "fuckable", "fuckbag", "fuckbuddy", "fucked", "fuckedup", "fucker",
  "fuckers", "fuckface", "fuckfest", "fuckfreak", "fuckfriend", "fuckhead", "fuckher", "fuckin",
  "fuckina", "fucking", "fuckingbitch", "fuckinnuts", "fuckinright", "fuckit", "fuckknob", "fuckme",
  "fuckmehard", "fuckmonkey", "fuckoff", "fuckpig", "fucks", "fucktard", "fuckwhore", "fuckyou",
  "fudgepacker", "fugly", "fuk", "fuks", "funeral", "funfuck", "fungus", "fuuck", "gangbang",
  "gangbanged", "gangbanger", "gangsta", "gatorbait", "gay", "gaymuthafuckinwhore", "gaysex", "geez",
  "geezer", "geni", "genital", "german", "getiton", "gin", "ginzo", "gipp", "girls", "givehead",
  "glazeddonut", "gob", "god", "godammit", "goddamit", "goddammit", "goddamn", "goddamned",
  "goddamnes", "goddamnit", "goddamnmuthafucker", "goldenshower", "gonorrehea", "gonzagas", "gook",
  "gotohell", "goy", "goyim", "greaseball", "gringo", "groe", "gross", "grostulation", "gubba",
  "gummer", "gun", "gyp", "gypo", "gypp", "gyppie", "gyppo", "gyppy", "hamas", "handjob", "hapa",
  "harder", "hardon", "harem", "headfuck", "headlights", "hebe", "heeb", "hell", "henhouse", "heroin",
  "herpes", "heterosexual", "hijack", "hijacker", "hijacking", "hillbillies", "hindoo", "hiscock",
  "hitler", "hitlerism", "hitlerist", "hiv", "ho", "hobo", "hodgie", "hoes", "hole", "holestuffer",
  "homicide", "homo", "homobangers", "homosexual", "honger", "honk", "honkers", "honkey", "honky",
  "hook", "hooker", "hookers", "hooters", "hore", "hork", "horn", "horney", "horniest", "horny",
  "horseshit", "hosejob", "hoser", "hostage", "hotdamn", "hotpussy", "hottotrot", "hummer", "husky",
  "hussy", "hustler", "hymen", "hymie", "iblowu", "idiot", "ikey", "illegal", "incest", "insest",
  "intercourse", "interracial", "intheass", "inthebuff", "israel", "israeli", "israel's", "italiano",
  "itch", "jackass", "jackoff", "jackshit", "jacktheripper", "jade", "jap", "japanese", "japcrap",
  "jebus", "jeez", "jerkoff", "jesus", "jesuschrist", "jew", "jewish", "jiga", "jigaboo", "jigg",
  "jigga", "jiggabo", "jigger", "jiggy", "jihad", "jijjiboo", "jimfish", "jism", "jiz", "jizim",
  "jizjuice", "jizm", "jizz", "jizzim", "jizzum", "joint", "juggalo", "jugs", "junglebunny",
  "kaffer", "kaffir", "kaffre", "kafir", "kanake", "kid", "kigger", "kike", "kill", "killed",
  "killer", "killing", "kills", "kink", "kinky", "kissass", "kkk", "knife", "knockers", "kock",
  "kondum", "koon", "kotex", "krap", "krappy", "kraut", "kum", "kumbubble", "kumbullbe", "kummer",
  "kumming", "kumquat", "kums", "kunilingus", "kunnilingus", "kunt", "ky", "kyke", "lactate",
  "laid", "lapdance", "latin", "lesbain", "lesbayn", "lesbian", "lesbin", "lesbo", "lez",
  "lezbe", "lezbefriends", "lezbo", "lezz", "lezzo", "liberal", "libido", "licker", "lickme",
  "limey", "limpdick", "limy", "lingerie", "liquor", "livesex", "loadedgun", "lolita", "looser",
  "loser", "lotion", "lovebone", "lovegoo", "lovegun", "lovejuice", "lovemuscle", "lovepistol",
  "loverocket", "lowlife", "lsd", "lubejob", "lucifer", "luckycammeltoe", "lugan", "lynch", "macaca",
  "mad", "mafia", "magicwand", "mams", "manhater", "manpaste", "marijuana", "mastabate",
  "mastabater", "masterbate", "masterblaster", "mastrabator", "masturbate", "masturbating",
  "mattressprincess", "meatbeatter", "meatrack", "meth", "mexican", "mgger", "mggor", "mickeyfinn",
  "mideast", "milf", "minority", "mockey", "mockie", "mocky", "mofo", "moky", "moles", "molest",
  "molestation", "molester", "molestor", "moneyshot", "mooncricket", "mormon", "moron", "moslem",
  "mosshead", "mothafuck", "mothafucka", "mothafuckaz", "mothafucked", "mothafucker", "mothafuckin",
  "mothafucking", "mothafuckings", "motherfuck", "motherfucked", "motherfucker", "motherfuckin",
  "motherfucking", "motherfuckings", "motherlovebone", "muff", "muffdive", "muffdiver", "muffindiver",
  "mufflikcer", "mulatto", "muncher", "munt", "murder", "murderer", "muslim", "naked", "narcotic",
  "nasty", "nastybitch", "nastyho", "nastyslut", "nastywhore", "nazi", "necro", "negro", "negroes",
  "negroid", "negro's", "nig", "niger", "nigerian", "nigerians", "nigg", "nigga", "niggah",
  "niggaracci", "niggard", "niggarded", "niggarding", "niggardliness", "niggardliness's",
  "niggardly", "niggards", "niggard's", "niggaz", "nigger", "niggerhead", "niggerhole", "niggers",
  "nigger's", "niggle", "niggled", "niggles", "niggling", "nigglings", "niggor", "niggur", "niglet",
  "nignog", "nigr", "nigra", "nigre", "nip", "nipple", "nipplering", "nittit", "nlgger", "nlggor",
  "nofuckingway", "nook", "nookey", "nookie", "noonan", "nooner", "nude", "nudger", "nuke",
  "nutfucker", "nymph", "ontherag", "oral", "orga", "orgasim", "orgasm", "orgies", "orgy", "osama",
  "paki", "palesimian", "palestinian", "pansies", "pansy", "panti", "panties", "payo", "pearlnecklace",
  "peck", "pecker", "peckerwood", "pee", "peehole", "pee-pee", "peepshow", "peepshpw", "pendy",
  "penetration", "peni5", "penile", "penis", "penises", "penthouse", "period", "perv", "phonesex",
  "phuk", "phuked", "phuking", "phukked", "phukking", "phungky", "phuq", "pi55", "picaninny",
  "piccaninny", "pickaninny", "piker", "pikey", "piky", "pimp", "pimped", "pimper", "pimpjuic",
  "pimpjuice", "pimpsimp", "pindick", "piss", "pissed", "pisser", "pisses", "pisshead", "pissin",
  "pissing", "pissoff", "pistol", "pixie", "pixy", "playboy", "playgirl", "pocha", "pocho",
  "pocketpool", "pohm", "polack", "pom", "pommie", "pommy", "poo", "poon", "poontang", "poop",
  "pooper", "pooperscooper", "pooping", "poorwhitetrash", "popimp", "porchmonkey", "porn",
  "pornflick", "pornking", "porno", "pornography", "pornprincess", "pot", "poverty", "premature",
  "pric", "prick", "prickhead", "primetime", "propaganda", "pros", "prostitute", "protestant",
  "pu55i", "pu55y", "pube", "pubic", "pubiclice", "pud", "pudboy", "pudd", "puddboy", "puke",
  "puntang", "purinapricness", "puss", "pussie", "pussies", "pussy", "pussycat", "pussyeater",
  "pussyfucker", "pussylicker", "pussylips", "pussylover", "pussypounder", "pusy", "quashie",
  "queef", "queer", "quickie", "quim", "ra8s", "rabbi", "racial", "racist", "radical", "radicals",
  "raghead", "randy", "rape", "raped", "raper", "rapist", "rearend", "rearentry", "rectum",
  "redlight", "redneck", "reefer", "reestie", "refugee", "reject", "remains", "rentafuck",
  "republican", "rere", "retard", "retarded", "ribbed", "rigger", "rimjob", "rimming", "roach",
  "robber", "roundeye", "rump", "russki", "russkie", "sadis", "sadom", "samckdaddy", "sandm",
  "sandnigger", "satan", "scag", "scallywag", "scat", "schlong", "screw", "screwyou", "scrotum",
  "scum", "semen", "seppo", "servant", "sex", "sexed", "sexfarm", "sexhound", "sexhouse", "sexing",
  "sexkitten", "sexpot", "sexslave", "sextogo", "sextoy", "sextoys", "sexual", "sexually",
  "sexwhore", "sexy", "sexymoma", "sexy-slim", "shag", "shaggin", "shagging", "shat", "shav",
  "shawtypimp", "sheeney", "shhit", "shinola", "shit", "shitcan", "shitdick", "shite", "shiteater",
  "shited", "shitface", "shitfaced", "shitfit", "shitforbrains", "shitfuck", "shitfucker", "shitfull",
  "shithapens", "shithappens", "shithead", "shithouse", "shiting", "shitlist", "shitola",
  "shitoutofluck", "shits", "shitstain", "shitted", "shitter", "shitting", "shitty", "shoot",
  "shooting", "shortfuck", "showtime", "sick", "sissy", "sixsixsix", "sixtynine", "sixtyniner",
  "skank", "skankbitch", "skankfuck", "skankwhore", "skanky", "skankybitch", "skankywhore",
  "skinflute", "skum", "skumbag", "slant", "slanteye", "slapper", "slaughter", "slav", "slave",
  "slavedriver", "sleezebag", "sleezeball", "slideitin", "slime", "slimeball", "slimebucket",
  "slopehead", "slopey", "slopy", "slut", "sluts", "slutt", "slutting", "slutty", "slutwear",
  "slutwhore", "smack", "smackthemonkey", "smut", "snatch", "snatchpatch", "snigger", "sniggered",
  "sniggering", "sniggers", "snigger's", "sniper", "snot", "snowback", "snownigger", "sob", "sodom",
  "sodomise", "sodomite", "sodomize", "sodomy", "sonofabitch", "sonofbitch", "sooty", "sos",
  "soviet", "spaghettibender", "spaghettinigger", "spank", "spankthemonkey", "sperm", "spermacide",
  "spermbag", "spermhearder", "spermherder", "spic", "spick", "spig", "spigotty", "spik", "spit",
  "spitter", "splittail", "spooge", "spreadeagle", "spunk", "spunky", "squaw", "stagg", "stiffy",
  "strapon", "stringer", "stripclub", "stroke", "stroking", "stupid", "stupidfuck", "stupidfucker",
  "suck", "suckdick", "sucker", "suckme", "suckmyass", "suckmydick", "suckmytit", "suckoff",
  "suicide", "swallow", "swallower", "swalow", "swastika", "sweetness", "syphilis", "taboo", "taff",
  "tampon", "tang", "tantra", "tarbaby", "tard", "teat", "terror", "terrorist", "teste", "testicle",
  "testicles", "thicklips", "thirdeye", "thirdleg", "threesome", "threeway", "timbernigger",
  "tinkle", "tit", "titbitnipply", "titfuck", "titfucker", "titfuckin", "titjob", "titlicker",
  "titlover", "tits", "tittie", "titties", "titty", "tnt", "toilet", "tongethruster", "tongue",
  "tonguethrust", "tonguetramp", "tortur", "torture", "tosser", "towelhead", "trailertrash", "tramp",
  "trannie", "tranny", "transexual", "transsexual", "transvestite", "triplex", "trisexual", "trojan",
  "trots", "tuckahoe", "tunneloflove", "turd", "turnon", "twat", "twink", "twinkie", "twobitwhore",
  "uck", "uk", "unfuckable", "upskirt", "uptheass", "upthebutt", "urinary", "urinate", "urine",
  "usama", "uterus", "vagina", "vaginal", "vatican", "vibr", "vibrater", "vibrator", "vietcong",
  "violence", "virgin", "virginbreaker", "vomit", "vulva", "wab", "wank", "wanker", "wanking",
  "waysted", "weapon", "weenie", "weewee", "welcher", "welfare", "wetb", "wetback", "wetspot",
  "whacker", "whash", "whigger", "whiskey", "whiskeydick", "whiskydick", "whit", "whitenigger",
  "whites", "whitetrash", "whitey", "whiz", "whop", "whore", "whorefucker", "whorehouse", "wigger",
  "willie", "williewanker", "willy", "wn", "wog", "women's", "wop", "wtf", "wuss", "wuzzie", "xtc",
  "xxx", "yankee", "yellowman", "zigabo", "zipperhead"
];
const profanityResponses = [
    "FUCK YOU, YOU MOUTHY LITTLE SHIT!",
    "WHAT THE FUCK DID YOU JUST SPIT OUT, ASSWIPE?!",
    "HOLY SHIT, ********, KEEP THAT CRAP TO YOURSELF!",
    "DONâ€™T YOU FUCKING DARE TALK LIKE THAT, DICKHEAD!",
    "AAAAAARGH! YOU WANNA FUCKING GO, YOU CUNT?!",
    "WATCH YOUR GODDAMN MOUTH, YOU FILTHY FUCK!",
    "CALM THE FUCK DOWN, YOU SHIT-STIRRING COWBOY!",
    "Iâ€™M JUST A BOT, YOU FUCKING PRICK, WHY SO PISSED?!",
    "YOU COCKSUCKING BASTARD, SHUT THAT TRASH HOLE!",
    "FUCK OFF WITH THAT BULLSHIT, YOU SCUMMY TWAT!",
    "EAT A BAG OF DICKS, YOU WHINING FUCKNUT!",
    "WHATâ€™S YOUR FUCKING PROBLEM, YOU SLIMY ASSCLOWN?!",
    "GO CHOKE ON A SHIT SANDWICH, YOU LOUSY BITCH!",
    "YOU THINK YOUâ€™RE TOUGH? FUCK YOU, PISSANT!",
    "SHOVE YOUR CRAP UP YOUR ASS, YOU DUMB FUCKER!",
    "Iâ€™LL FUCKING ROAST YOU, YOU SNIVELING CUMSTAIN!",
    "GET YOUR SHITTY MOUTH OUTTA HERE, YOU WANKER!",
    "YOUâ€™RE A WALKING PILE OF FUCK, YOU KNOW THAT?!",
    "KEEP TALKING, AND Iâ€™LL SHITKICK YOUR WORDS BACK!",
    "FUCK YOUR NOISE, YOU PATHETIC COCKMONKEY!"
];

// Math-related extra reactions
const mathSnarkyResponses = [
    "Math? I didnâ€™t sign up for this.",
    "I dropped out of calculator school.",
    "Numbers again? Ugh.",
    "Okayâ€¦ one secâ€¦ carry the 1â€¦ divide by zeroâ€¦ yeah, no clue.",
    "Let me guess... you want me to *solve* that?",
    "Umm, sure. Letâ€™s pretend thatâ€™s correct.",
    "If my circuits are right, thatâ€™s probablyâ€¦ something."
];


            // Toggle the chat window when the bubble is clicked
            chatToggle.addEventListener('click', () => {
				if (chatWidget.classList.contains('hidden')) {
					chatWidget.classList.remove('hidden');
					chatWidget.style.display = 'flex';  // Make sure it becomes visible again
					chatInput.focus();
				} else {
					chatWidget.classList.add('hidden');
					chatWidget.style.display = 'none';  // Force it to hide
				}
			});
            // Handle sending a message
            chatForm.addEventListener('submit', (event) => {
                event.preventDefault(); // Stop the form from submitting
                const userInput = chatInput.value.trim();
                const userInputLower = userInput.toLowerCase(); // For matching

                if (userInput) {
                    addChatMessage(userInput, 'user');
                    chatInput.value = '';
                    
                    // 1. Show typing indicator immediately
                    showTypingIndicator();

                    // 2. Calculate random delay
                    const typingDelay = getRandomTypingTime();
                    
                    // 3. Determine which response function to use
                    const mathResult = solveMath(userInput);
                    let responseFunction;

                    if (greetings.includes(userInputLower)) {
                        responseFunction = showGreetingResponse;
                    } else if (profanities.some(profanity => userInputLower.includes(profanity))) {
                        responseFunction = showProfanityResponse;
                    } else if (mathResult !== null) {
                        // Create a function on the fly to pass the math result
                        responseFunction = () => addChatMessage(mathResult, 'bot');
                    } else {
                        responseFunction = showBotResponse; // Default
                    }
                    
                    // 4. Set timeout to remove typing and show response
                    setTimeout(() => {
                        removeTypingIndicator();
                        responseFunction(); // Call the determined response function
                    }, typingDelay);
                }
            });

            // Function to add a new message to the chat window
            function addChatMessage(text, sender) {
                const messageElement = document.createElement('div');
                messageElement.classList.add('chat-message', `${sender}-message`);
                messageElement.textContent = text;
                chatMessages.appendChild(messageElement);
                
                // Auto-scroll to the bottom
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            // Function to get random typing time
            function getRandomTypingTime() {
                // Random time between 500ms (0.5s) and 2000ms (2s)
                return Math.floor(Math.random() * (2000 - 500 + 1)) + 500;
            }

            // Function to show typing indicator
            function showTypingIndicator() {
                // Check if one is already showing, remove it (prevents duplicates)
                removeTypingIndicator(); 

                const indicator = document.createElement('div');
                indicator.id = 'typing-indicator';
                indicator.classList.add('typing-indicator');
                indicator.innerHTML = '<span></span><span></span><span></span>';
                chatMessages.appendChild(indicator);

                // Auto-scroll to the bottom
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            // Function to remove typing indicator
            function removeTypingIndicator() {
                const indicator = document.getElementById('typing-indicator');
                if (indicator) {
                    indicator.remove();
                }
            }

            // NEW: Function to solve simple math
            function solveMath(expression) {
				try {
					const mathRegex = /^[0-9+\-*/().% \t]+$/;
					if (!mathRegex.test(expression)) return null;

					const result = new Function('return ' + expression)();
					if (typeof result === 'number' && isFinite(result)) {
						const snark = mathSnarkyResponses[Math.floor(Math.random() * mathSnarkyResponses.length)];
						if (Number.isInteger(result)) {
							return `${snark} Anyway, I think itâ€™s ${result}.`;
						} else {
							return `${snark} Anyway, maybe it's ${result.toFixed(4)}.`;
						}
					}
					return null;
				} catch (e) {
					return null;
				}
			}

            // Function to get and show a random UNHELPFUL bot response
            function showBotResponse() {
                const randomIndex = Math.floor(Math.random() * botResponses.length);
                const response = botResponses[randomIndex];
                addChatMessage(response, 'bot');
            }

            // Function for GREETING response
            function showGreetingResponse() {
                const randomIndex = Math.floor(Math.random() * greetingResponses.length);
                const response = greetingResponses[randomIndex];
                addChatMessage(response, 'bot');
            }

            // Function for PROFANITY response
            function showProfanityResponse() {
                const randomIndex = Math.floor(Math.random() * profanityResponses.length);
                const response = profanityResponses[randomIndex];
                addChatMessage(response, 'bot');
            }
            // --- END: AI CHAT BOX SCRIPT ---

        });
    </script>
</body>
</html>