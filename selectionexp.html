<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" href="favicon.png" type="image/png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="styles.css">
    <script src="theme.js"></script>
    <style>
        /* Any custom overrides or specific element styles not covered by themes */
        a {
            text-decoration: none;
        }
        .user-icon-border {
            border-color: var(--text-color);
        }
        .theme-na-box {
            background-color: var(--input-bg-color);
            border-color: var(--accent-color);
        }
        .theme-section-bg {
            background-color: var(--box-bg-color);
        }
        .theme-tile-bg {
            background-color: var(--card-bg-color);
        }
        .theme-tile-border {
            border: 1px solid var(--border-color);
        }
        .theme-text-color {
            color: var(--text-color);
        }
        .theme-subtle-text {
            color: var(--subtle-text-color);
        }

        /* New class for the larger tiles (20% increase) */
        .large-tile-padding {
            padding: 1.5rem; /* Base padding */
            font-size: 1.125rem; /* Base text size */
        }
        .large-tile-padding .text-lg {
             font-size: 1.35rem; /* Scale up the text inside */
        }
        .large-tile-padding .w-8 {
             width: 2.5rem; /* Scale up icon size */
             height: 2.5rem;
        }
        /* --- Modal Styles --- */
        .fullscreen-embed-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            display: flex;
            flex-direction: column; /* Allows content and close button to stack */
            justify-content: center;
            align-items: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            padding-top: 4rem; /* Space for the header */
        }
        .fullscreen-embed-modal.show {
            opacity: 1;
            visibility: visible;
        }
        /* NOTE: The ID #fullscreenEmbedContent is now the wrapper for content and title. */
        .modal-content {
            background-color: var(--bg-color); /* This will be the content's background color when showing iframes/videos/pdfs */
            padding: 2rem;
            border-radius: 0.75rem;
            width: 95%;
            max-width: 90vw;
            height: 90vh; /* Use height for fullscreen display */
            max-height: 90vh;
            overflow: hidden;
            transform: scale(0.95);
            transition: transform 0.3s ease;
            position: relative;
            display: flex;
            flex-direction: column;
        }
        .fullscreen-embed-modal.show .modal-content {
            transform: scale(1);
        }
        .close-embed-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            cursor: pointer;
            z-index: 1010;
        }
        .modal-header {
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }
        /* Style for content inside the modal (iframe or dynamic content) */
        /* NOTE: Now targetting #dynamicEmbedContent's children */
        #dynamicEmbedContent > iframe, 
        #dynamicEmbedContent > embed, 
        #dynamicEmbedContent > .aspect-video {
            flex-grow: 1; /* Allows the content to fill the remaining space */
            border: none;
            width: 100%;
        }
        
        /* Ensure the dynamic content area also acts as a flex container to manage its children */
        #dynamicEmbedContent {
            flex-grow: 1; 
            display: flex;
            flex-direction: column;
            width: 100%;
        }
    </style>
</head>
<body class="theme-bg-color min-h-screen font-sans">

    <div id="customModalOverlay" class="modal-overlay">
        <div class="custom-modal">
            <h3 id="customModalTitle" class="custom-modal-header" style="color: var(--text-color) !important;">Alert</h3>
            <p id="customModalMessage" class="custom-modal-body theme-text-color"></p>
            <div class="custom-modal-footer">
                <button id="customModalCancelBtn" class="modal-button theme-button-secondary transition hidden">Cancel</button>
                <button id="customModalOkBtn" class="modal-button theme-button-primary transition">OK</button>
            </div>
        </div>
    </div>

<header class="theme-section-bg shadow-lg fixed top-0 w-full z-50">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
    <h1 class="text-3xl font-bold theme-text-color">User Dashboard</h1>

    <nav class="space-x-4 flex items-center">
      <p class="theme-text-color font-medium hidden sm:block">
        Welcome, <span id="userNameDisplay">User</span>
      </p>

      <div class="relative inline-block text-left">
        <button id="themeToggle" type="button"
          class="p-2 rounded-full theme-text-color hover:bg-gray-200/50 dark:hover:bg-gray-700/50 transition-colors flex items-center justify-center space-x-1"
          aria-expanded="false" aria-haspopup="true">
          <span id="currentThemeIcon" class="w-6 h-6 flex items-center justify-center"></span>
          <svg id="dropdownArrow" class="w-4 h-4 transition-transform duration-200"
            fill="none" stroke="currentColor" viewBox="0 0 24 24"
            xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M19 9l-7 7-7-7"></path>
          </svg>
        </button>
        <div id="themeDropdownMenu"
          class="absolute right-0 mt-2 w-48 rounded-lg shadow-2xl theme-section-bg ring-1 ring-black ring-opacity-10 origin-top-right hidden theme-dropdown-menu">
          <div class="py-1" role="menu" aria-orientation="vertical" aria-labelledby="themeToggle"
            id="themeOptions"></div>
        </div>
      </div>

      <button id="logoutButton"
        class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300">
        Log Out
      </button>
    </nav>
  </div>
</header>





    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 mt-20">
        <h2 class="text-2xl font-semibold mb-6 theme-text-color">Modules & Resources</h2>
		<section id="userStatsSection" class="col-span-12 p-6 rounded-2xl shadow-lg theme-section-bg border theme-tile-border transition-transform transform hover:scale-[1.01] mb-8">
  <div class="flex items-center justify-between mb-4">
    <h3 class="text-2xl font-semibold theme-text-color flex items-center">
      <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 mr-2 text-[var(--accent-color)]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3v18h18M9 9l3 3 6-6" />
      </svg>
      Your Statistics
    </h3>
    <p class="text-sm theme-subtle-text">
      <span id="lastUpdatedText">Last updated: just now</span>
      <button id="refreshStatsBtn" class="ml-2 text-[var(--accent-color)] hover:underline text-sm font-medium">Refresh</button>
    </p>
  </div>

  <div id="statisticsLoadingIndicator" class="text-center text-lg font-semibold theme-subtle-text hidden py-4">
    Loading statistics...
  </div>

  <div id="statisticsContent" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6">
    <div class="p-5 rounded-xl border theme-tile-border theme-tile-bg text-center transition-transform transform hover:scale-[1.02] shadow-md">
      <p id="citationCount" class="text-4xl font-bold text-[var(--accent-color)]">--</p>
      <p class="theme-text-color font-medium mt-1">Citations Filled</p>
    </div>
    <div class="p-5 rounded-xl border theme-tile-border theme-tile-bg text-center transition-transform transform hover:scale-[1.02] shadow-md">
      <p id="shiftCount" class="text-4xl font-bold text-[var(--accent-color)]">--</p>
      <p class="theme-text-color font-medium mt-1">Shifts Logged</p>
    </div>
    <div class="p-5 rounded-xl border theme-tile-border theme-tile-bg text-center transition-transform transform hover:scale-[1.02] shadow-md">
      <p id="arrestCount" class="text-4xl font-bold text-[var(--accent-color)]">--</p>
      <p class="theme-text-color font-medium mt-1">Arrests Logged</p>
    </div>
  </div>
</section>

        <div class="grid grid-cols-12 gap-6">

            <div class="col-span-12 sm:col-span-6 lg:col-span-3">
                <a href="leaderboard.html" id="leaderboardButton" class="hidden block p-6 large-tile-padding rounded-xl shadow-lg transition duration-300 hover:shadow-xl transform hover:scale-[1.02] theme-tile-bg theme-tile-border theme-text-color">
                    <div class="flex items-center space-x-4">
                        <svg class="w-8 h-8 text-[var(--accent-color)] transition-colors duration-300" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" fill="currentColor" preserveAspectRatio="xMidYMid meet">

							<g transform="translate(0.000000,50.000000) scale(0.100000,-0.100000)" stroke="none">
								<path d="M167 404 c-4 -4 -7 -24 -7 -45 l0 -38 -77 -3 -78 -3 -3 -113 -3 -112 251 0 251 0 -3 92 -3 93 -77 3 -77 3 -3 62 -3 62 -80 3 c-45 1 -84 0 -88 -4z m153 -79 l0 -65 80 0 80 0 0 -75 0 -75 -230 0 -230 0 0 95 0 95 80 0 80 0 0 45 0 45 70 0 70 0 0 -65z"/>
								<path d="M245 354 c-13 -5 -7 -74 6 -74 5 0 9 18 9 40 0 22 -1 40 -2 39 -2 0 -8 -3 -13 -5z"/>
								<path d="M77 263 c-14 -13 -6 -25 8 -13 12 10 15 10 15 -3 0 -8 -7 -20 -15 -27 -23 -19 -18 -30 13 -29 18 1 21 3 9 6 -17 4 -18 6 -2 24 10 10 15 25 12 34 -7 15 -28 20 -40 8z"/>
								<path d="M384 219 c-5 -8 -2 -11 8 -7 11 5 15 -1 15 -22 0 -21 -4 -27 -16 -23 -13 5 -13 3 -4 -7 20 -22 43 -4 40 32 -3 34 -28 50 -43 27z"/>
							</g>
						</svg>
                        <span class="text-lg font-semibold">Leaderboard</span>
                    </div>
                </a>
            </div>
            
            <div class="col-span-12 sm:col-span-6 lg:col-span-3">
                <a href="citation.html" class="block p-6 large-tile-padding rounded-xl shadow-lg transition duration-300 hover:shadow-xl transform hover:scale-[1.02] theme-tile-bg theme-tile-border theme-text-color">
                    <div class="flex items-center space-x-4">
                         <svg class="w-8 h-8 text-[var(--accent-color)] transition-colors duration-300" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" fill="currentColor" preserveAspectRatio="xMidYMid meet">

							<g transform="translate(0.000000,50.000000) scale(0.100000,-0.100000)" stroke="none">
								<path d="M175 481 c-6 -6 -32 -11 -60 -13 l-50 -3 0 -215 0 -215 185 0 185 0 0 215 0 215 -50 3 c-27 2 -54 7 -59 13 -6 5 -40 9 -76 9 -36 0 -70 -4 -75 -9z m135 -41 l0 -30 -60 0 -60 0 0 30 0 30 60 0 60 0 0 -30z m-140 0 c0 -5 -16 -10 -35 -10 l-35 0 0 -180 0 -180 150 0 150 0 0 180 0 180 -35 0 c-19 0 -35 5 -35 10 0 6 20 10 45 10 l45 0 0 -200 0 -200 -170 0 -170 0 0 200 0 200 45 0 c25 0 45 -4 45 -10z m5 -40 c3 -5 37 -10 75 -10 38 0 72 5 75 10 3 6 17 10 31 10 l24 0 0 -160 0 -160 -130 0 -130 0 0 160 0 160 24 0 c14 0 28 -4 31 -10z"/>
								<path d="M160 300 c0 -6 37 -10 90 -10 53 0 90 4 90 10 0 6 -37 10 -90 10 -53 0 -90 -4 -90 -10z"/>
								<path d="M160 240 c0 -6 37 -10 90 -10 53 0 90 4 90 10 0 6 -37 10 -90 10 -53 0 -90 -4 -90 -10z"/>
								<path d="M160 180 c0 -6 37 -10 90 -10 53 0 90 4 90 10 0 6 -37 10 -90 10 -53 0 -90 -4 -90 -10z"/>
							</g>
						</svg>
                        <span class="text-lg font-semibold">Issue Citation</span>
                    </div>
                </a>
            </div>

            <div class="col-span-12 sm:col-span-6 lg:col-span-3">
                <a href="arrest.html" class="block p-6 large-tile-padding rounded-xl shadow-lg transition duration-300 hover:shadow-xl transform hover:scale-[1.02] theme-tile-bg theme-tile-border theme-text-color">
                    <div class="flex items-center space-x-4">
                        <svg class="w-8 h-8 text-[var(--accent-color)] transition-colors duration-300" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" fill="currentColor" preserveAspectRatio="xMidYMid meet">

							<g transform="translate(0.000000,50.000000) scale(0.100000,-0.100000)" stroke="none">
								<path d="M272 468 c-7 -7 -12 -18 -12 -25 0 -7 -9 -17 -21 -24 -17 -9 -25 -7 -43 10 -28 26 -38 26 -61 1 -10 -11 -31 -20 -47 -20 -41 0 -88 -48 -88 -90 0 -43 23 -93 55 -118 74 -58 185 -23 185 59 0 14 9 34 20 44 25 23 25 33 -1 61 -24 26 -17 48 13 38 17 -5 19 -2 16 22 -4 35 12 40 43 15 21 -17 22 -22 11 -40 -10 -18 -10 -21 3 -21 8 0 18 12 21 27 12 46 -62 93 -94 61z m-60 -85 l47 -46 -20 -25 c-10 -14 -19 -36 -19 -49 0 -32 -42 -73 -75 -73 -60 0 -125 63 -125 121 0 38 36 79 69 79 15 0 36 9 46 20 10 11 21 20 24 20 3 0 27 -21 53 -47z"/>
								<path d="M185 369 c-4 -6 -5 -13 -2 -16 7 -7 27 6 27 18 0 12 -17 12 -25 -2z"/>
								<path d="M57 352 c-39 -43 2 -125 69 -138 61 -11 91 37 62 101 -23 50 -100 72 -131 37z m98 -27 c39 -39 29 -95 -18 -95 -24 0 -77 53 -77 77 0 47 56 57 95 18z"/>
								<path d="M315 414 c-18 -19 -14 -58 11 -85 23 -26 17 -49 -16 -55 -37 -8 -54 -27 -47 -56 3 -13 -1 -32 -9 -42 -24 -33 -18 -84 14 -116 58 -58 164 -48 209 19 31 46 29 83 -6 123 -16 19 -31 45 -33 58 -3 22 -8 25 -40 24 -42 -1 -52 18 -18 36 20 11 25 35 14 64 -10 27 -24 18 -18 -12 5 -25 3 -29 -16 -27 -30 2 -46 32 -31 58 16 25 8 32 -14 11z m105 -163 c0 -10 14 -35 30 -56 38 -47 38 -79 1 -115 -50 -51 -132 -52 -171 -3 -23 30 -25 58 -5 93 7 14 11 37 8 52 -5 25 -2 27 48 36 81 15 89 14 89 -7z"/>
								<path d="M340 236 c0 -8 4 -17 9 -20 10 -7 23 19 14 28 -11 11 -23 6 -23 -8z"/>
								<path d="M311 174 c-38 -31 -39 -57 -5 -91 21 -21 32 -25 66 -20 22 3 51 16 64 28 75 71 -45 151 -125 83z m110 -4 c27 -15 24 -45 -7 -69 -32 -25 -61 -27 -92 -5 -27 19 -28 38 -2 64 22 22 70 26 101 10z"/>
							</g>
						</svg>
                        <span class="text-lg font-semibold">Process Arrest</span>
                    </div>
                </a>
            </div>

            <div class="col-span-12 sm:col-span-6 lg:col-span-3">
                <a href="shift_log.html" class="block p-6 large-tile-padding rounded-xl shadow-lg transition duration-300 hover:shadow-xl transform hover:scale-[1.02] theme-tile-bg theme-tile-border theme-text-color">
                    <div class="flex items-center space-x-4">
                        <svg class="w-8 h-8 text-[var(--accent-color)] transition-colors duration-300" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" fill="currentColor" preserveAspectRatio="xMidYMid meet">
						<g transform="translate(0,50) scale(0.1,-0.1)" stroke="none">
							<path d="M80 460 c-19 -19 -20 -33 -20 -214 0 -190 1 -195 22 -210 18 -13 55 -16 190 -16 103 0 168 4 168 10 0 6 -68 11 -171 12 -148 3 -173 5 -182 20 -8 12 -7 21 2 32 11 13 40 16 182 16 l169 0 0 185 0 185 -170 0 c-157 0 -172 -2 -190 -20z m340 -165 l0 -165 -154 0 c-85 0 -161 -3 -170 -6 -14 -5 -16 12 -16 153 0 110 4 163 12 171 8 8 60 12 170 12 l158 0 0 -165z"/>
							<path d="M134 396 c-3 -8 -4 -25 -2 -38 3 -23 5 -23 123 -23 l120 0 0 35 0 35 -118 3 c-95 2 -118 0 -123 -12z m226 -26 c0 -19 -7 -20 -105 -20 -98 0 -105 1 -105 20 0 19 7 20 105 20 98 0 105 -1 105 -20z"/>
						</g>
					</svg>
                        <span class="text-lg font-semibold">Submit Shift Log</span>
                    </div>
                </a>
            </div>
            
            <div class="col-span-12 sm:col-span-6 lg:col-span-3">
                <button id="helpDeskTile" class="w-full text-left p-6 rounded-xl shadow-lg transition duration-300 hover:shadow-xl transform hover:scale-[1.02] theme-tile-bg theme-tile-border theme-text-color">
                    <div class="flex items-center space-x-4">
                        <svg class="w-8 h-8 text-[var(--accent-color)] transition-colors duration-300" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" fill="currentColor" preserveAspectRatio="xMidYMid meet">

							<g transform="translate(0.000000,50.000000) scale(0.100000,-0.100000)" stroke="none">
								<path d="M155 456 c-60 -28 -87 -56 -114 -116 -36 -79 -19 -183 42 -249 33 -36 115 -71 167 -71 52 0 134 35 167 71 34 37 63 110 63 159 0 52 -35 134 -71 167 -37 34 -110 63 -159 63 -27 0 -65 -10 -95 -24z m180 -15 c128 -58 164 -223 72 -328 -101 -115 -283 -88 -348 52 -79 171 104 354 276 276z"/>
								<path d="M206 354 c-18 -18 -21 -44 -5 -44 6 0 18 9 27 21 11 13 23 18 34 14 28 -11 30 -37 3 -75 -24 -35 -34 -80 -16 -80 4 0 23 29 41 64 32 62 33 65 16 90 -19 30 -75 36 -100 10z"/>
								<path d="M237 164 c-14 -15 -6 -34 14 -34 14 0 19 5 17 17 -3 18 -20 27 -31 17z"/>
							</g>
						</svg>
                        <span class="text-lg font-semibold">Help Desk (Docs)</span>
                    </div>
                </button>
            </div>

            <div class="col-span-12 sm:col-span-6 lg:col-span-3">
                <div class="block p-6 rounded-xl shadow-lg theme-tile-bg theme-tile-border theme-text-color opacity-75 cursor-not-allowed">
                    <div class="flex items-center space-x-4">
                        <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        <span class="text-lg font-semibold theme-subtle-text">Coming Soon</span>
                    </div>
                </div>
            </div>

            <div class="col-span-12 sm:col-span-6 lg:col-span-3">
                <div class="block p-6 rounded-xl shadow-lg theme-tile-bg theme-tile-border theme-text-color opacity-75 cursor-not-allowed">
                    <div class="flex items-center space-x-4">
                        <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        <span class="text-lg font-semibold theme-subtle-text">Coming Soon</span>
                    </div>
                </div>
            </div>
            
            <div class="col-span-12 sm:col-span-6 lg:col-span-3">
                <div class="block p-6 rounded-xl shadow-lg theme-tile-bg theme-tile-border theme-text-color opacity-75 cursor-not-allowed">
                    <div class="flex items-center space-x-4">
                        <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        <span class="text-lg font-semibold theme-subtle-text">Coming Soon</span>
                    </div>
                </div>
            </div>

            <div class="col-span-12 mt-4 flex justify-center">
                <div class="w-full sm:w-1/2 md:w-1/3 lg:w-1/4"> <a href="admin.html" id="adminButton" class="hidden block p-6 rounded-xl shadow-lg transition duration-300 hover:shadow-xl transform hover:scale-[1.02] theme-tile-bg theme-tile-border theme-text-color">
                        <div class="flex items-center space-x-4">
                            <svg class="w-8 h-8 text-[var(--accent-color)] transition-colors duration-300" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" fill="currentColor" preserveAspectRatio="xMidYMid meet">

								<g transform="translate(0.000000,50.000000) scale(0.100000,-0.100000)" stroke="none">
									<path d="M180 475 c-25 -14 -69 -32 -99 -41 l-54 -16 7 -66 c14 -132 77 -251 167 -318 l49 -36 28 21 c47 33 109 106 136 160 28 55 56 157 56 208 0 29 -4 33 -42 44 -23 6 -68 24 -100 40 -69 35 -89 35 -148 4z m155 -30 c44 -19 88 -35 98 -35 12 0 17 -8 17 -27 0 -50 -30 -155 -58 -206 -33 -61 -117 -147 -144 -147 -30 0 -116 94 -148 163 -28 60 -50 144 -50 193 0 16 6 24 18 24 9 0 51 16 92 34 41 19 80 34 85 35 6 1 46 -15 90 -34z"/>
								</g>
							</svg>
                            <span class="text-lg font-semibold">Admin Panel</span>
                        </div>
                    </a>
                </div>
            </div>
        </div>
    </main>

    <div id="fullscreenEmbedModal" class="fullscreen-embed-modal">
        <button id="closeEmbedBtn" class="close-embed-btn">Close (Esc)</button>
        <div id="fullscreenEmbedContent" class="modal-content"> 
            <h3 id="modalTitle" class="text-xl font-bold theme-text-color modal-header"></h3>
            <div id="dynamicEmbedContent" style="flex-grow: 1; border: none; width: 100%;">
                </div>
        </div>
    </div>
    
    <script>
        // IMPORTANT: Set your Cloudflare R2 Public URL here
        const R2_BASE_URL = "https://pub-a91d9d22a6264a88b02227540eadf4cb.r2.dev/tutorials"; 

        const fullscreenEmbedModal = document.getElementById('fullscreenEmbedModal');
        // REVISED: fullscreenEmbedContent is now the wrapper element
        const fullscreenEmbedContent = document.getElementById('fullscreenEmbedContent');
        // NEW: dynamicEmbedContent is the target for content injection
        const dynamicEmbedContent = document.getElementById('dynamicEmbedContent');
        const helpDeskTile = document.getElementById('helpDeskTile');
        const closeEmbedBtn = document.getElementById('closeEmbedBtn');
        const helpDeskUrl = 'help_desk.html';

        
        /**
         * Dynamically loads PDF or Video content into the fullscreen modal.
         * @param {string} embedType - 'pdf' or 'video'
         * @param {string} relativeUrl - The R2 path (e.g., '/cite/citations_video.mp4')
         * @param {string} title - The title of the document/video
         */
        function openFullscreenEmbedModal(embedType, relativeUrl, title) {
            // Check dynamicEmbedContent instead of fullscreenEmbedContent (which is the wrapper)
            if (!fullscreenEmbedModal || !dynamicEmbedContent) return; 

            const fullUrl = R2_BASE_URL + relativeUrl;

            // Clear previous content (only the dynamic content area)
            dynamicEmbedContent.innerHTML = '';
            // Reset background on the wrapper
            fullscreenEmbedContent.style.backgroundColor = 'var(--bg-color)'; 

            // Set the title (This will now work as modalTitle is NOT cleared)
            document.getElementById('modalTitle').textContent = title || 'Resource Viewer';

            // Use a container for 16:9 aspect ratio if it's a video
            const container = document.createElement('div');
            container.classList.add('w-full', 'h-full', 'flex', 'items-center', 'justify-center');


            if (embedType === 'pdf') {
                fullscreenEmbedContent.style.padding = '0'; // Remove padding for full PDF view
                const embed = document.createElement('embed');
                embed.src = fullUrl;
                embed.type = 'application/pdf';
                embed.style.width = '100%';
                embed.style.height = '100%';
                embed.style.flexGrow = '1';
                dynamicEmbedContent.appendChild(embed); // Use dynamic content area
            } else if (embedType === 'video') {
                fullscreenEmbedContent.style.padding = '2rem'; // Restore padding for video spacing
                
                // Create a 16:9 responsive wrapper for the video, centered in the modal
                const videoWrapper = document.createElement('div');
                videoWrapper.classList.add('relative', 'w-full', 'max-w-4xl', 'mx-auto', 'aspect-video', 'flex-grow');

                const video = document.createElement('video');
                video.controls = true;
                video.autoplay = true;
                video.preload = 'auto';
                video.setAttribute('allowfullscreen', '');
                
                const source = document.createElement('source');
                source.src = fullUrl;
                source.type = relativeUrl.includes('.mp4') ? 'video/mp4' : 'video/webm'; 
                
                video.appendChild(source);
                video.classList.add('absolute', 'inset-0', 'w-full', 'h-full', 'rounded-xl', 'shadow-2xl');

                videoWrapper.appendChild(video);
                dynamicEmbedContent.appendChild(videoWrapper); // Use dynamic content area
            } else if (embedType === 'iframe') {
                // This is used for the Help Desk initial page (help_desk.html)
                fullscreenEmbedContent.style.padding = '0'; 
                fullscreenEmbedContent.style.backgroundColor = 'var(--card-bg-color)';
                // Title is already set above, but override with a specific one for the initial screen
                document.getElementById('modalTitle').textContent = 'Help Desk Documentation';
                const iframe = document.createElement('iframe');
                iframe.id = 'helpDeskIframe';
                iframe.src = relativeUrl;
                iframe.frameborder = '0';
                iframe.classList.add('w-full', 'h-full', 'flex-grow');
                dynamicEmbedContent.appendChild(iframe); // Use dynamic content area
            }

            // Show the modal
            fullscreenEmbedModal.classList.add('show');
            document.body.style.overflow = 'hidden'; // Prevent scrolling background
        }

        /**
         * Function to close the fullscreen modal and stop video playback.
         */
        function closeFullscreenEmbedModal() {
			if (!fullscreenEmbedModal) return;
			document.body.style.overflow = ''; // Restore scrolling
			fullscreenEmbedModal.classList.remove('show');
    
			// Find any video element in the dynamic content area and pause it to stop sound
			const videoElement = dynamicEmbedContent.querySelector('video');
			if (videoElement) {
			videoElement.pause();
			}
    
			// ------------------------------------------------------------------
			// FIX: Clear content IMMEDIATELY, not after a setTimeout delay. 
			// This prevents the content of the new modal from being cleared later.
			// ------------------------------------------------------------------
			dynamicEmbedContent.innerHTML = ''; // Clear dynamic content immediately
			fullscreenEmbedContent.style.padding = '2rem'; // Reset padding on the wrapper immediately
        }

        
        // --- DOM Event Listeners ---
        document.addEventListener('DOMContentLoaded', function() {
            
            // Added try...catch block to prevent uncaught errors from crashing the page
            try { 
                // --- User Authentication and Display (Existing Logic) ---
                const loggedInUserString = sessionStorage.getItem('loggedInUser');
                
                if (loggedInUserString) {
                    const loggedInUser = JSON.parse(loggedInUserString);
                    const userNameDisplay = document.getElementById('userNameDisplay');
                    
                    if (userNameDisplay) {
						// Match selection.html behavior
						userNameDisplay.textContent = loggedInUser.username || 'User';
					}

                    const adminButton = document.getElementById('adminButton');
                    const leaderboardButton = document.getElementById('leaderboardButton');

                    if (adminButton && leaderboardButton) {
                        // Check user role for showing Admin and Leaderboard links
                        if (loggedInUser.role === 'admin') {
                            adminButton.classList.remove('hidden');
                            leaderboardButton.classList.remove('hidden');
                        } else {
                            adminButton.classList.add('hidden');
                            leaderboardButton.classList.remove('hidden');
                        }
                    }
                } else {
                    // Redirect if no user info is found (unauthenticated state)
                    window.location.href = 'index.html';
                }
                // --- End Existing Logic ---


                // --- Help Desk/Modal Setup ---
                if (helpDeskTile) {
                    helpDeskTile.addEventListener('click', () => {
                        // 1. Open the primary modal with the help_desk.html iframe
                        // FIX: openFullscreenEmbedModal now works correctly even without the title argument for iframe
                        openFullscreenEmbedModal('iframe', helpDeskUrl);

                        // 2. Attach a listener to the iframe once it's loaded to handle nested R2 link clicks
                        const helpDeskIframe = document.getElementById('helpDeskIframe');
                        
                        if (helpDeskIframe) {
                            helpDeskIframe.onload = function() {
                                try {
                                    const iframeDocument = helpDeskIframe.contentDocument || helpDeskIframe.contentWindow.document;
                                    
                                    // Check if we already attached the listener to prevent duplicates
                                    if (!iframeDocument.body.getAttribute('data-r2-listener-attached')) {
                                        
                                        iframeDocument.body.addEventListener('click', function(event) {
                                            const target = event.target.closest('.r2-embed-link');

                                            if (target) {
                                                event.preventDefault(); // Stop default button action

                                                const type = target.getAttribute('data-embed-type');
                                                const url = target.getAttribute('data-url');
                                                const title = target.textContent;
                                                
                                                // Close the current iframe modal (the one showing help_desk.html)
                                                closeFullscreenEmbedModal(); 
                                                
                                                // Open the new fullscreen embed modal with the PDF/Video
                                                // We add a slight delay to ensure the modal is fully closed before re-opening 
                                                // (to prevent visual glitches during rapid transition)
                                                setTimeout(() => {
                                                    openFullscreenEmbedModal(type, url, title); 
                                                }, 100); 
                                            }
                                        });
                                        iframeDocument.body.setAttribute('data-r2-listener-attached', 'true');
                                    }
                                } catch (error) {
                                    console.error("Error setting up iframe listener. Ensure help_desk.html is served from the same origin as the dashboard.", error);
                                }
                            };
                        }
                    });
                }

                if (closeEmbedBtn) {
                    closeEmbedBtn.addEventListener('click', closeFullscreenEmbedModal);
                }

                // Close modals on Escape key
                document.addEventListener('keydown', function(event) {
                    if (event.key === 'Escape') {
                        // Check for fullscreen modal
                        if (fullscreenEmbedModal && fullscreenEmbedModal.classList.contains('show')) {
                            closeFullscreenEmbedModal();
                        }
                        // Check for custom alert modal
                        const customModalOverlay = document.getElementById('customModalOverlay');
                        if (customModalOverlay && customModalOverlay.classList.contains('show')) {
                             // Logic to handle ESC key for custom alert is now in theme.js
                        }
                    }
                });

                // Close modals on outside click
                document.addEventListener('click', function(event) {
                    if (event.target === fullscreenEmbedModal) {
                        closeFullscreenEmbedModal();
                    }
                });
                // --- End Modal Setup ---
            } catch (error) {
                console.error("Dashboard Initialization Failed Gracefully:", error);
                // The page will remain visually available, but critical functions might be disabled.
            }
        });
		const logoutButton = document.getElementById('logoutButton');
if (logoutButton) {
  logoutButton.addEventListener('click', function (event) {
    event.preventDefault();
    // Use custom confirm modal (from theme.js)
    if (window.showCustomConfirm) {
      window.showCustomConfirm("Are you sure you want to log out?", "Confirm Logout").then((confirmed) => {
        if (confirmed) {
          sessionStorage.clear();
          window.location.href = 'index.html';
        }
      });
    } else {
      // Fallback if theme.js modal isn’t loaded
      if (confirm("Are you sure you want to log out?")) {
        sessionStorage.clear();
        window.location.href = 'index.html';
      }
    }
  });
}
    </script>
<button id="chat-toggle" title="Open AI Help" type="button"
    class="fixed bottom-6 right-6 w-14 h-14 rounded-full flex items-center justify-center shadow-lg cursor-pointer z-50 transition-transform duration-200"
    style="background-color: var(--accent-color); color: var(--button-text-color); border: none;">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
        stroke-width="2.5" stroke="currentColor" class="w-7 h-7 pointer-events-none">
        <path stroke-linecap="round" stroke-linejoin="round"
              d="M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 
                 1.172 1.025 1.172 2.687 0 3.712-.203.179-.43.326-.67.442
                 -.745.361-1.45.999-1.45 1.827v.75M21 12a9 9 0 1 1-18 0
                 9 9 0 0 1 18 0Zm-9 5.25h.008v.008H12v-.008Z"/>
    </svg>
</button>

<div id="chat-widget"
    class="hidden fixed bottom-24 right-6 w-96 max-w-[90vw] h-[480px] rounded-xl shadow-2xl flex flex-col overflow-hidden z-50 transition-all duration-300"
    style="background-color: var(--box-bg-color); border: 1px solid var(--border-color);">
    
    <div id="chat-widget-header" class="p-3 font-semibold flex justify-between items-center"
        style="background-color: var(--border-color); color: var(--text-color);">
        <span>AI Help Bot</span>
        <button id="chat-close" class="text-sm font-bold px-2 rounded transition"
            style="color: var(--button-text-color); background-color: var(--accent-color);">X</button>
    </div>

    <div id="chat-messages" class="flex flex-col gap-2 p-3 overflow-y-auto flex-grow"
        style="background-color: var(--input-bg-color); color: var(--text-color);">
        <div class="chat-message bot-message"
             style="background-color: var(--button-secondary-bg); color: var(--text-color);
                    padding: 0.5rem 0.75rem; border-radius: 0.5rem; align-self: flex-start;">
            Hello! How can I not help you?
        </div>
    </div>

    <form id="chat-form" class="flex items-center px-2 py-2"
          style="background-color: color-mix(in srgb, var(--input-bg-color) 85%, black);
                 border-top: 1px solid var(--border-color);">
        <input id="chat-input" type="text" placeholder="Ask a question..."
               class="flex-grow px-3 py-2 border-none outline-none rounded-md mr-2"
               style="background-color: var(--box-bg-color); color: var(--text-color);" autocomplete="off" />
        <button type="submit" id="chat-send-btn"
                class="px-4 py-2 font-semibold border-none rounded-md transition"
                style="background-color: var(--accent-color); color: var(--button-text-color);">
            Send
        </button>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const chatToggle = document.getElementById('chat-toggle');
    const chatWidget = document.getElementById('chat-widget');
    const chatClose = document.getElementById('chat-close');
    const chatForm = document.getElementById('chat-form');
    const chatInput = document.getElementById('chat-input');
    const chatMessages = document.getElementById('chat-messages');

    const botResponses = [
        "What?", "Refresh the website.", "I don't know.",
        "Can you ask a question regarding the website please?",
        "Sorry, I am not programmed to help with that.",
        "Try turning your monitor off and on again.",
        "Hmm... that sounds like a you problem.",
        "My last brain cell just left the chat.",
        "That’s above my pay grade.",
        "Have you tried asking Google?",
        "I forgot.", "Hold on, I’ll ask my supervisor.",
        "Great question, but I’m just here for decoration."
    ];
    const greetings = ["hi", "hello", "hey", "yo", "sup"];
    const greetingResponses = ["Hello!", "Hey there!", "Hi!", "Howdy!", "Greetings, officer!"];
    const profanities = ["fuck","shit","bitch","asshole","cunt","damn","dick","fag","piss"];
    const profanityResponses = [
        "Whoa there, language!", "Easy, officer!",
        "Watch your mouth!", "Calm down, partner.", "Let's keep it civil!"
    ];

    chatToggle.addEventListener('click', () => {
        chatWidget.classList.toggle('hidden');
        if (!chatWidget.classList.contains('hidden')) chatInput.focus();
    });
    chatClose.addEventListener('click', () => chatWidget.classList.add('hidden'));

    function addChatMessage(text, sender) {
        const msg = document.createElement('div');
        msg.classList.add('chat-message');
        msg.style.padding = '0.5rem 0.75rem';
        msg.style.borderRadius = '0.5rem';
        msg.style.maxWidth = '80%';
        msg.style.wordWrap = 'break-word';
        if (sender === 'user') {
            msg.style.backgroundColor = 'var(--accent-color)';
            msg.style.color = 'var(--button-text-color)';
            msg.style.alignSelf = 'flex-end';
        } else {
            msg.style.backgroundColor = 'var(--button-secondary-bg)';
            msg.style.color = 'var(--text-color)';
            msg.style.alignSelf = 'flex-start';
        }
        msg.textContent = text;
        chatMessages.appendChild(msg);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function showTypingIndicator() {
        const indicator = document.createElement('div');
        indicator.classList.add('typing-indicator');
        indicator.style.padding = '0.5rem 0.75rem';
        indicator.style.borderRadius = '0.5rem';
        indicator.style.backgroundColor = 'var(--button-secondary-bg)';
        indicator.style.color = 'var(--text-color)';
        indicator.style.alignSelf = 'flex-start';
        indicator.innerHTML = '<span>●</span><span>●</span><span>●</span>';
        indicator.querySelectorAll('span').forEach((dot, i) => {
            dot.style.animation = `blink 1.2s infinite ${i * 0.2}s alternate`;
        });
        chatMessages.appendChild(indicator);
        chatMessages.scrollTop = chatMessages.scrollHeight;
        return indicator;
    }

    function removeTypingIndicator(indicator) {
        if (indicator && indicator.parentNode) indicator.parentNode.removeChild(indicator);
    }

    chatForm.addEventListener('submit', e => {
        e.preventDefault();
        const text = chatInput.value.trim();
        if (!text) return;
        addChatMessage(text, 'user');
        chatInput.value = '';
        const typing = showTypingIndicator();

        setTimeout(() => {
            removeTypingIndicator(typing);
            const lower = text.toLowerCase();
            let reply;
            if (greetings.some(g => lower.includes(g))) {
                reply = greetingResponses[Math.floor(Math.random() * greetingResponses.length)];
            } else if (profanities.some(p => lower.includes(p))) {
                reply = profanityResponses[Math.floor(Math.random() * profanityResponses.length)];
            } else {
                reply = botResponses[Math.floor(Math.random() * botResponses.length)];
            }
            addChatMessage(reply, 'bot');
        }, 800 + Math.random() * 800);
    });
});
// === Statistics Section Logic ===
document.addEventListener('DOMContentLoaded', function () {
  const token = sessionStorage.getItem('authToken');
  const userInfo = JSON.parse(sessionStorage.getItem('loggedInUser') || '{}');

  const citationCountEl = document.getElementById('citationCount');
  const shiftCountEl = document.getElementById('shiftCount');
  const arrestCountEl = document.getElementById('arrestCount');
  const loaderEl = document.getElementById('statisticsLoadingIndicator');
  const contentEl = document.getElementById('statisticsContent');
  const lastUpdatedEl = document.getElementById('lastUpdatedText');
  const refreshBtn = document.getElementById('refreshStatsBtn');

  if (!token || !userInfo.username) return;

  const baseUrl = 'https://citation-app-worker.pnbober.workers.dev';
  const headers = {
    'Content-Type': 'application/json',
    'Authorization': `Bearer ${token}`,
  };

  function timeAgo(dateString) {
    const seconds = Math.floor((Date.now() - new Date(dateString)) / 1000);
    if (seconds < 60) return 'just now';
    const minutes = Math.floor(seconds / 60);
    if (minutes < 60) return `${minutes}m ago`;
    const hours = Math.floor(minutes / 60);
    if (hours < 24) return `${hours}h ago`;
    const days = Math.floor(hours / 24);
    return `${days}d ago`;
  }

  function updateTimestamp() {
    const lastUpdated = sessionStorage.getItem('statsLastUpdated');
    if (lastUpdated) lastUpdatedEl.textContent = `Last updated: ${timeAgo(lastUpdated)}`;
  }

  async function loadStats(force = false) {
    loaderEl.classList.remove('hidden');
    contentEl.classList.add('hidden');

    const cacheKey = 'userStats';
    const cached = sessionStorage.getItem(cacheKey);

    // If 'force' is true (Refresh button clicked), fetch new data and write to cache.
    if (force) {
      try {
        const username = userInfo.username.toLowerCase();
        const [citationsRes, shiftsRes, arrestsRes] = await Promise.all([
          fetch(`${baseUrl}/citations`, { headers }),
          fetch(`${baseUrl}/shift-logs`, { headers }),
          fetch(`${baseUrl}/arrest-logs`, { headers }),
        ]);

        let citations = 0, shifts = 0, arrests = 0;

        if (citationsRes.ok) {
          const data = await citationsRes.json();
          citations = data.filter(c => c.submittedBy?.toLowerCase() === username).length;
        }
        if (shiftsRes.ok) {
          const data = await shiftsRes.json();
          shifts = data.filter(s => s.submittedByUsername?.toLowerCase() === username).length;
        }
        if (arrestsRes.ok) {
          const data = await arrestsRes.json();
          arrests = data.filter(a => a.submittedByUsername?.toLowerCase() === username).length;
        }

        citationCountEl.textContent = citations;
        shiftCountEl.textContent = shifts;
        arrestCountEl.textContent = arrests;

        const statsToCache = {
          username: userInfo.username,
          citations,
          shifts,
          arrests,
        };
        sessionStorage.setItem(cacheKey, JSON.stringify(statsToCache));
        
        // --- ADDED CONFIRMATION LINE ---
        console.log('Statistics saved to cache.', statsToCache);
        // ---------------------------------
        
        sessionStorage.setItem('statsLastUpdated', new Date().toISOString());
        updateTimestamp();
      } catch (err) {
        console.error('Error fetching stats:', err);
        citationCountEl.textContent = '--';
        shiftCountEl.textContent = '--';
        arrestCountEl.textContent = '--';
      } finally {
        loaderEl.classList.add('hidden');
        contentEl.classList.remove('hidden');
      }
      return; // Stop execution after fetching.
    }

    // If 'force' is false (automatic page load), just try to read from cache.
    if (cached) {
      try {
        const parsed = JSON.parse(cached);
        // Check if cached stats belong to the current user
        if (parsed.username === userInfo.username) {
          citationCountEl.textContent = parsed.citations;
          shiftCountEl.textContent = parsed.shifts;
          arrestCountEl.textContent = parsed.arrests;
          updateTimestamp();
        } else {
          // Cache is for a different user, show defaults
          citationCountEl.textContent = '--';
          shiftCountEl.textContent = '--';
          arrestCountEl.textContent = '--';
        }
      } catch (e) {
        // Cache is corrupt, show defaults
        console.error('Error parsing cached stats:', e);
        citationCountEl.textContent = '--';
        shiftCountEl.textContent = '--';
        arrestCountEl.textContent = '--';
      }
    } else {
      // No cache, show defaults. Do not fetch.
      citationCountEl.textContent = '--';
      shiftCountEl.textContent = '--';
      arrestCountEl.textContent = '--';
    }
    
    // Hide loader and show content (with cached data or defaults)
    loaderEl.classList.add('hidden');
    contentEl.classList.remove('hidden');
  }

  // Initialize + refresh click
  loadStats();
  refreshBtn.addEventListener('click', () => loadStats(true));
  setInterval(updateTimestamp, 60 * 1000); // auto-refresh display every minute
});


</script>

<style>
@keyframes blink {
    0% { opacity: 0.3; transform: scale(0.9); }
    100% { opacity: 1; transform: scale(1.2); }
}
</style>

</body>
</html>