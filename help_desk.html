// IMPORTANT: Replace this placeholder with your actual Cloudflare R2 public URL
const R2_BASE_URL = "YOUR_CLOUDFLARE_R2_PUBLIC_URL_HERE"; 

const fullscreenEmbedModal = document.getElementById('fullscreenEmbedModal');
const fullscreenEmbedContent = document.getElementById('fullscreenEmbedContent');
const helpDeskTile = document.getElementById('helpDeskTile');
const closeEmbedBtn = document.getElementById('closeEmbedBtn');

/**
 * Dynamically loads PDF or Video content into the fullscreen modal.
 * This function recreates the core functionality from your original selection.html script.
 * @param {string} embedType - 'pdf' or 'video'
 * @param {string} relativeUrl - The R2 path (e.g., '/cite/citations_video.mp4')
 */
function openFullscreenEmbedModal(embedType, relativeUrl) {
    if (!fullscreenEmbedModal || !fullscreenEmbedContent) return;

    const fullUrl = R2_BASE_URL + relativeUrl;

    // Clear previous content
    fullscreenEmbedContent.innerHTML = '';
    
    // Set the modal title (optional, adjust as needed)
    const title = relativeUrl.split('/').pop().replace(/_/g, ' ');
    document.getElementById('modalTitle').textContent = title;

    if (embedType === 'pdf') {
        const embed = document.createElement('embed');
        embed.src = fullUrl;
        embed.type = 'application/pdf';
        embed.style.width = '100%';
        embed.style.height = '100%';
        fullscreenEmbedContent.appendChild(embed);
    } else if (embedType === 'video') {
        const video = document.createElement('video');
        video.controls = true;
        video.autoplay = true;
        video.preload = 'auto';
        video.setAttribute('allowfullscreen', '');
        
        const source = document.createElement('source');
        source.src = fullUrl;
        source.type = relativeUrl.includes('.mp4') ? 'video/mp4' : ''; 
        
        video.appendChild(source);
        video.style.width = '100%';
        video.style.height = '100%';
        video.classList.add('rounded-xl', 'shadow-2xl');

        fullscreenEmbedContent.appendChild(video);
    } else {
        fullscreenEmbedContent.innerHTML = `<p class="text-red-500 p-4">Unsupported embed type: ${embedType}</p>`;
    }

    fullscreenEmbedModal.classList.add('show');
}

/**
 * Sets up the cross-iframe listener when the help desk tile is clicked.
 */
if (helpDeskTile) {
    helpDeskTile.addEventListener('click', () => {
        // Wait for the iframe to load
        const helpDeskIframe = document.getElementById('helpDeskIframe');

        helpDeskIframe.onload = function() {
            try {
                // Get the iframe's document body
                const iframeDocument = helpDeskIframe.contentDocument || helpDeskIframe.contentWindow.document;

                // Add a listener to the iframe document that looks for clicks on the buttons
                iframeDocument.body.addEventListener('click', function(event) {
                    const target = event.target.closest('.r2-embed-link');

                    if (target) {
                        event.preventDefault(); // Stop default button action

                        const type = target.getAttribute('data-embed-type');
                        const url = target.getAttribute('data-url');
                        
                        // Use the core function to open the content in the main modal
                        openFullscreenEmbedModal(type, url); 
                    }
                });
            } catch (error) {
                console.error("Error setting up iframe listener. This may be due to cross-origin restrictions if the help desk content is served from a different domain.", error);
            }
        };

        // Standard modal open for the help desk iframe
        openTileModal(helpDeskTile.getAttribute('data-url'), helpDeskTile.getAttribute('data-title'));
    });
}

// Attach close listener to the close button
if (closeEmbedBtn) {
    closeEmbedBtn.addEventListener('click', closeFullscreenEmbedModal);
}

// Function to close the fullscreen modal and stop video playback
function closeFullscreenEmbedModal() {
    if (!fullscreenEmbedModal) return;
    fullscreenEmbedModal.classList.remove('show');
    
    // Find any video element and pause it to stop sound
    const videoElement = fullscreenEmbedContent.querySelector('video');
    if (videoElement) {
        videoElement.pause();
    }
    
    // Clear content after transition
    setTimeout(() => {
        fullscreenEmbedContent.innerHTML = '';
    }, 300);
}
