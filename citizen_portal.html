<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" href="favicon.png" type="image/png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Citizen Portal</title> 
	<script>
      // prevent light-mode flash
      (function() {
        try {
          const savedTheme = localStorage.getItem('theme');
          const theme = savedTheme || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
          document.documentElement.classList.add(theme);
          document.documentElement.setAttribute('data-theme', theme);
        } catch(e) { console.warn('Theme preloader failed:', e); }
        document.documentElement.style.visibility = 'hidden';
        window.addEventListener('DOMContentLoaded', () => { document.documentElement.style.visibility = ''; });
      })();
    </script>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="styles.css">
    <script src="theme.js" defer></script> 
    <style>
        /* All styles from my_garage.html */
        .dashboard-form-container { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); transition: box-shadow 0.3s; }
        :root { --app-header-height: 5rem; --sidebar-width: 250px; --sidebar-collapsed-width: 65px; }
        header.theme-section-bg { background-color: var(--box-bg-color) !important; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); position: fixed; top: 0; height: auto; min-height: 4rem; z-index: 50; box-sizing: border-box; transition: width 0.3s, left 0.3s; }
        .main-header {
			width: calc(100vw - var(--sidebar-width));
			left: var(--sidebar-width);
			transition: width 0.3s ease, left 0.3s ease;
		}
        .main-content-wrapper { margin-left: var(--sidebar-width); flex-grow: 1; box-sizing: border-box; padding-top: 0; transition: none; position: relative; z-index: 1; }
        .sidebar.collapsed { width: var(--sidebar-collapsed-width); min-width: var(--sidebar-collapsed-width); }
        .sidebar.collapsed .sidebar-item { padding: 0.75rem 0; justify-content: center; }
        .sidebar.collapsed .sidebar-item-text, .sidebar.collapsed .sidebar-user-info, .sidebar.collapsed .sidebar-title, .sidebar.collapsed .sidebar-logout-text { display: none; }
        .sidebar.collapsed .sidebar-item-icon { margin-left: 0; }
        .sidebar.collapsed .sidebar-item.active { border-left-color: transparent; }
        .sidebar.collapsed .sidebar-toggle-button { transform: translateY(-50%) rotate(180deg); }
        		.main-header.collapsed {
			width: calc(100vw - var(--sidebar-collapsed-width));
			left: var(--sidebar-collapsed-width);
		}
        @media (max-width: 1024px) {
            .sidebar { display: block; } .main-content-wrapper { margin-left: var(--sidebar-width); } .main-header { width: calc(100% - var(--sidebar-width)); left: var(--sidebar-width); }
             .sidebar.collapsed { width: 0; min-width: 0; overflow: hidden; box-shadow: none; border-right: none;} .sidebar.collapsed .sidebar-toggle-button { right: -30px; }
             .main-content-wrapper.collapsed { margin-left: 0; } .main-header.collapsed { width: 100%; left: 0; }
        }
        .sidebar { width: var(--sidebar-width); min-width: var(--sidebar-width); background-color: var(--box-bg-color); color: var(--text-color); position: fixed; top: 0; left: 0; height: 100vh; padding-top: 2rem; box-shadow: 2px 0 5px rgba(0, 0, 0, 0.2); z-index: 40; display: flex; flex-direction: column; justify-content: space-between; transition: width 0.3s, min-width 0.3s; border-right: 1px solid var(--border-color); }
        .sidebar-item { display: flex; align-items: center; padding: 0.75rem 1.5rem; font-size: 1.125rem; font-weight: 500; border-left: 5px solid transparent; transition: background-color 0.2s, border-left-color 0.2s; }
        .sidebar-item:hover, .sidebar-item.active { background-color: var(--input-bg-color); }
        .sidebar-item.active { border-left-color: var(--accent-color); color: var(--accent-color); font-weight: 700; }
        .sidebar-item-icon { min-width: 24px; text-align: center; }
        .sidebar-item-text { margin-left: 1rem; transition: opacity 0.3s; }
        .sidebar-user-info { padding: 1rem 1.5rem; border-top: 1px solid var(--border-color); font-size: 0.875rem; transition: opacity 0.3s; }
        .sidebar-toggle-button { position: absolute; right: -12px; top: 50%; transform: translateY(-50%); width: 24px; height: 24px; border-radius: 50%; background-color: var(--accent-color); color: white; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2); transition: transform 0.3s, background-color 0.3s, right 0.3s; z-index: 50; }
        .theme-input {
            background-color: var(--input-bg-color); color: var(--text-color); border: 1px solid var(--border-color); border-radius: 0.5rem; padding: 0.75rem; box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.06); width: 100%; transition: border-color 0.2s, box-shadow 0.2s;
        }
        .info-label { 
            font-weight: 600; 
            color: var(--text-color); /* Updated for better contrast in cards */
            min-width: 100px; /* Adjusted min-width slightly */ 
            display: inline-block; 
        }
        .info-value { color: var(--text-color); }
        code { background-color: color-mix(in srgb, var(--input-bg-color) 80%, var(--border-color)); /* Slightly adjusted bg */ padding: 0.1em 0.3em; border-radius: 0.25rem; font-family: monospace; font-size: 0.9em; }

        /* Styles copied from my_garage.html */
        .column-card { border: 1px solid var(--border-color); background-color: var(--card-bg-color); border-radius: 0.75rem; padding: 1.5rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); min-height: 300px; display: flex; flex-direction: column; }
        .column-content { flex-grow: 1; overflow-y: auto; padding-right: 5px; /* Add slight padding for scrollbar */ }
        .vehicle-card, .trailer-card, .record-card { 
            border: 1px solid var(--border-color); 
            background-color: var(--input-bg-color); /* Ensure high contrast with .info-label */
            border-radius: 0.5rem; 
            padding: 1rem; 
            margin-bottom: 1rem; 
            position: relative; 
        }
        /* New custom ban level colors/classes */
        .ban-level-0 { color: #22c55e; } /* Green */
        .ban-level-1 { color: #facc15; } /* Yellow */
        .ban-level-2 { color: #f97316; } /* Orange */
        .ban-level-3 { color: #ef4444; } /* Red */
        .ban-level-4 { color: #8b5cf6; } /* Violet */
        .ban-level-unknown { color: var(--subtle-text-color); }

        .registration-form { border: 1px solid var(--border-color); background-color: var(--input-bg-color); border-radius: 0.75rem; padding: 1.5rem; margin-top: 1rem; }
        .add-button { color: #22c55e; font-size: 1.5rem; font-weight: bold; transition: color 0.2s; }
        .add-button:hover { color: #16a34a; }

        /* Styles for themed select */
        .theme-input select, select.theme-input {
            appearance: none; background-image: url('data:image/svg+xml;charset=UTF-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>'); background-repeat: no-repeat; background-position: right 0.5rem center; background-size: 1.5em 1.5em; padding-right: 2.5rem;
        }
        /* Focus state */
        .theme-input:focus { outline: none; border-color: var(--accent-color); box-shadow: 0 0 0 2px color-mix(in srgb, var(--accent-color) 30%, transparent); }
        /* Registration Form Labels override subtle text color for contrast */
        .registration-form .theme-label { color: var(--text-color); } 


        /* Theme Dropdown Styles */
        .theme-dropdown-menu { background-color: var(--box-bg-color); border: 1px solid var(--border-color); opacity: 1; z-index: 60; position: absolute; right: 0; margin-top: 0.5rem; width: 12rem; border-radius: 0.5rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); origin-y: top; display: none; }
        .theme-dropdown-menu button { color: var(--text-color); width: 100%; text-align: left; padding: 0.5rem 1rem; } /* Added button styling */
        .theme-dropdown-menu button:hover { background-color: var(--input-bg-color); }

        /* Style for Paid Checkbox Area */
        .record-card .absolute { line-height: 1; } /* Ensure checkbox aligns well */
        .record-card .paid-checkbox:disabled { opacity: 0.7; cursor: not-allowed; }
    </style>
</head>
<body class="min-h-screen theme-app-container flex flex-row theme-bg-color">

    <div id="customModalOverlay" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
         <div class="custom-modal theme-lookup-box p-6 rounded-xl shadow-xl max-w-sm w-full mx-4 sm:mx-auto">
            <h3 id="customModalTitle" class="custom-modal-header theme-title text-xl font-bold mb-4">Alert</h3>
            <p id="customModalMessage" class="custom-modal-body theme-label mb-6"></p>
            <div id="customModalButtons" class="custom-modal-footer flex justify-end space-x-3">
                <button id="customModalCancelBtn" class="theme-button-secondary py-2 px-4 rounded-lg font-semibold hidden">Cancel</button>
                <button id="customModalOkBtn" class="theme-button-primary py-2 px-4 rounded-lg font-semibold">OK</button>
            </div>
        </div>
    </div>

    <div class="sidebar" id="appSidebar">
         <div id="sidebarToggle" class="sidebar-toggle-button">
             <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 19l-7-7 7-7m8 14l-7-7 7-7"></path></svg>
        </div>
        <div>
            <div class="text-2xl font-bold px-6 mb-8 text-[var(--accent-color)] sidebar-title">Citizen Portal</div>
            <a href="citizen_portal.html" class="sidebar-item active">
                <span class="sidebar-item-icon"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg></span>
                <span class="sidebar-item-text">My Portal</span>
            </a>
        </div>
        <div class="sidebar-user-info theme-subtle-text">
            <p class="font-bold mb-1 theme-text-color" id="sidebarCitizenUsernameDisplay"></p>
            <p class="block theme-subtle-text">Shadow LE Web© 2025</p>
            <button id="citizenLogoutBtn" class="theme-subtle-text text-sm hover:underline mt-2">Logout</button>
        </div>
    </div>

    <header class="theme-section-bg fixed top-0 w-full z-50 main-header" id="appHeader">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            <div class="flex items-end space-x-4 min-w-0 flex-grow"> <!-- MODIFIED: ADDED flex-grow to title container -->
                <h1 class="text-3xl sm:text-2xl md:text-3xl font-bold theme-text-color truncate min-w-0">Welcome, <span id="welcomeMessageDisplay">Loading Portal</span></h1> <!-- MODIFIED: Added responsive text sizing -->
            </div>
            <nav class="space-x-4 flex items-center min-w-0 flex-shrink-0 sm:flex-shrink"> 
                 <p class="theme-text-color font-medium hidden sm:block min-w-0 flex-shrink truncate">Welcome, <span id="citizenUserNameDisplay">Citizen</span></p> 
                <div class="relative inline-block text-left flex-shrink-0">
                    <button id="themeToggle" type="button" class="p-2 rounded-full theme-text-color hover:bg-gray-200/50 dark:hover:bg-gray-700/50 transition-colors flex items-center justify-center space-x-1" aria-expanded="false" aria-haspopup="true">
                        <span id="currentThemeIcon" class="w-6 h-6 flex items-center justify-center"></span>
                        <svg id="dropdownArrow" class="w-4 h-4 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div id="themeDropdownMenu" class="theme-dropdown-menu absolute right-0 mt-2 w-48 rounded-lg shadow-2xl ring-1 ring-black ring-opacity-10 origin-top-right hidden">
                        <div class="py-1" role="menu" aria-orientation="vertical" aria-labelledby="themeToggle" id="themeOptions"></div>
                    </div>
                </div>
            </nav>
        </div>
    </header>

    <main class="main-content-wrapper p-4 sm:p-6 lg:p-8" id="mainContentArea">
        <div class="container mx-auto max-w-7xl w-full">
            
            <div id="contentColumns" class="flex flex-col lg:flex-row gap-6">

                <div id="vehiclesSection" class="column-card flex-1">
                     <div class="flex justify-between items-center mb-4 pb-2 border-b border-[var(--border-color)]">
                         <h2 class="theme-title text-xl font-bold flex items-center">My Vehicles</h2>
                         <button id="showAddVehicleFormBtn" class="add-button" title="Add New Vehicle">+</button>
                     </div>
                     <div class="column-content">
                        <form id="addVehicleForm" class="registration-form hidden mb-6">
                            <h3 id="addVehicleFormTitle" class="theme-title font-semibold text-xl mb-4">Register New Vehicle</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div><label for="vehicleBrand" class="theme-label block mb-1 text-sm font-medium">Brand:</label><input type="text" id="vehicleBrand" name="brand" required class="theme-input w-full p-2 border rounded-lg text-sm"></div>
                                <div><label for="vehicleModel" class="theme-label block mb-1 text-sm font-medium">Model:</label><input type="text" id="vehicleModel" name="model" required class="theme-input w-full p-2 border rounded-lg text-sm"></div>
                                <div><label for="vehicleYear" class="theme-label block mb-1 text-sm font-medium">Year:</label><input type="number" id="vehicleYear" name="year" required class="theme-input w-full p-2 border rounded-lg text-sm" min="1900" max="2100"></div>
                                <div><label for="vehicleColor" class="theme-label block mb-1 text-sm font-medium">Color:</label><input type="text" id="vehicleColor" name="color" required class="theme-input w-full p-2 border rounded-lg text-sm"></div>
                                <div><label for="vehiclePlate" class="theme-label block mb-1 text-sm font-medium">Plate Text:</label><input type="text" id="vehiclePlate" name="plateText" required class="theme-input w-full p-2 border rounded-lg text-sm uppercase" maxlength="10"></div>
                                <div>
                                    <label for="vehicleState" class="theme-label block mb-1 text-sm font-medium">State:</label>
                                    <select id="vehicleState" name="state" required class="theme-input w-full p-2 border rounded-lg text-sm">
                                        <option value="">Select State...</option>
                                        <option value="AL">Alabama</option><option value="AK">Alaska</option><option value="AZ">Arizona</option><option value="AR">Arkansas</option><option value="CA">California</option><option value="CO">Colorado</option><option value="CT">Connecticut</option><option value="DE">Delaware</option><option value="DC">District Of Columbia</option><option value="FL">Florida</option><option value="GA">Georgia</option><option value="HI">Hawaii</option><option value="ID">Idaho</option><option value="IL">Illinois</option><option value="IN">Indiana</option><option value="IA">Iowa</option><option value="KS">Kansas</option><option value="KY">Kentucky</option><option value="LA">Louisiana</option><option value="ME">Maine</option><option value="MD">Maryland</option><option value="MA">Massachusetts</option><option value="MI">Michigan</option><option value="MN">Minnesota</option><option value="MS">Mississippi</option><option value="MO">Missouri</option><option value="MT">Montana</option><option value="NE">Nebraska</option><option value="NV">Nevada</option><option value="NH">New Hampshire</option><option value="NJ">New Jersey</option><option value="NM">New Mexico</option><option value="NY">New York</option><option value="NC">North Carolina</option><option value="ND">North Dakota</option><option value="OH">Ohio</option><option value="OK">Oklahoma</option><option value="OR">Oregon</option><option value="PA">Pennsylvania</option><option value="RI">Rhode Island</option><option value="SC">South Carolina</option><option value="SD">South Dakota</option><option value="TN">Tennessee</option><option value="TX">Texas</option><option value="UT">Utah</option><option value="VT">Vermont</option><option value="VA">Virginia</option><option value="WA">Washington</option><option value="WV">West Virginia</option><option value="WI">Wisconsin</option><option value="WY">Wyoming</option><option value="OT">Other</option>
                                      </select>
                                  </div>
                                <div><label for="vehicleBanLvl" class="theme-label block mb-1 text-sm font-medium">Vehicle Ban Lvl:</label><input type="number" id="vehicleBanLvl" name="vehicleBanLvl" required class="theme-input w-full p-2 border rounded-lg text-sm" min="0" max="4" value="0"></div>
                            </div>
                            <div class="mt-4 flex justify-end space-x-2">
                                <button type="button" id="cancelAddVehicleBtn" class="theme-button-secondary py-2 px-4 rounded-lg font-semibold text-sm">Cancel</button>
                                <button type="submit" id="addVehicleSubmitBtn" class="theme-button-primary py-2 px-4 rounded-lg font-semibold text-sm">Register Vehicle</button>
                            </div>
                        </form>	
                        <div id="vehicleList">
                            <p id="noVehiclesMessage" class="theme-subtle-text text-center mt-4">No vehicles found.</p>
                        </div>
                    </div>
                </div>

                <div id="recordSection" class="column-card flex-1">
                    <div class="flex justify-between items-center mb-4 pb-2 border-b border-[var(--border-color)]">
                        <h2 class="theme-title text-xl font-bold flex items-center">My Record</h2>
                    </div>
                    <div class="column-content">
                        <div id="recordUserInfo" class="mb-4">
                             <p class="text-sm"><span class="info-label">Discord ID:</span> <span id="recordDiscordId" class="info-value font-mono">--</span></p>
                        </div>
                        <h3 class="theme-title font-semibold mb-2">Citations & Arrests:</h3>
                        <div id="recordList">
                            <p id="noRecordsMessage" class="theme-subtle-text text-center mt-4">You have a clean record!</p>
                        </div>
                    </div>
                </div>

                <div id="trailersSection" class="column-card flex-1">
                    <div class="flex justify-between items-center mb-4 pb-2 border-b border-[var(--border-color)]">
                        <h2 class="theme-title text-xl font-bold flex items-center">My Trailers</h2>
                        <button id="showAddTrailerFormBtn" class="add-button" title="Add New Trailer">+</button>
                    </div>
                    <div class="column-content">
                         <form id="addTrailerForm" class="registration-form hidden mb-6">
                              <h3 id="addTrailerFormTitle" class="theme-title font-semibold text-xl mb-4">Register New Trailer</h3>
                              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                  <div><label for="trailerModel" class="theme-label block mb-1 text-sm font-medium">Trailer Model:</label><input type="text" id="trailerModel" name="trailerModel" required class="theme-input w-full p-2 border rounded-lg text-sm"></div>
                                  <div><label for="trailerColor" class="theme-label block mb-1 text-sm font-medium">Trailer Color:</label><input type="text" id="trailerColor" name="trailerColor" required class="theme-input w-full p-2 border rounded-lg text-sm"></div>
                                  <div class="md:col-span-2"><label for="trailerPlate" class="theme-label block mb-1 text-sm font-medium">Plate Text:</label><input type="text" id="trailerPlate" name="trailerPlate" required class="theme-input w-full p-2 border rounded-lg text-sm uppercase" maxlength="10"></div>
                                  <div class="md:col-span-2">
                                      <label for="trailerState" class="theme-label block mb-1 text-sm font-medium">State:</label>
                                      <select id="trailerState" name="state" required class="theme-input w-full p-2 border rounded-lg text-sm">
                                          <option value="">Select State...</option>
                                          <option value="AL">Alabama</option><option value="AK">Alaska</option><option value="AZ">Arizona</option><option value="AR">Arkansas</option><option value="CA">California</option><option value="CO">Colorado</option><option value="CT">Connecticut</option><option value="DE">Delaware</option><option value="DC">District Of Columbia</option><option value="FL">Florida</option><option value="GA">Georgia</option><option value="HI">Hawaii</option><option value="ID">Idaho</option><option value="IL">Illinois</option><option value="IN">Indiana</option><option value="IA">Iowa</option><option value="KS">Kansas</option><option value="KY">Kentucky</option><option value="LA">Louisiana</option><option value="ME">Maine</option><option value="MD">Maryland</option><option value="MA">Massachusetts</option><option value="MI">Michigan</option><option value="MN">Minnesota</option><option value="MS">Mississippi</option><option value="MO">Missouri</option><option value="MT">Montana</option><option value="NE">Nebraska</option><option value="NV">Nevada</option><option value="NH">New Hampshire</option><option value="NJ">New Jersey</option><option value="NM">New Mexico</option><option value="NY">New York</option><option value="NC">North Carolina</option><option value="ND">North Dakota</option><option value="OH">Ohio</option><option value="OK">Oklahoma</option><option value="OR">Oregon</option><option value="PA">Pennsylvania</option><option value="RI">Rhode Island</option><option value="SC">South Carolina</option><option value="SD">South Dakota</option><option value="TN">Tennessee</option><option value="TX">Texas</option><option value="UT">Utah</option><option value="VT">Vermont</option><option value="VA">Virginia</option><option value="WA">Washington</option><option value="WV">West Virginia</option><option value="WI">Wisconsin</option><option value="WY">Wyoming</option><option value="OT">Other</option>
                                      </select>
                                  </div>
                              </div>
                              <div class="mt-4 flex justify-end space-x-2">
                                  <button type="button" id="cancelAddTrailerBtn" class="theme-button-secondary py-2 px-4 rounded-lg font-semibold text-sm">Cancel</button>
                                  <button type="submit" id="addTrailerSubmitBtn" class="theme-button-primary py-2 px-4 rounded-lg font-semibold text-sm">Register Trailer</button>
                              </div>
                         </form>
                        <div id="trailerList">
                            <p id="noTrailersMessage" class="theme-subtle-text text-center mt-4">No trailers found.</p>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </main>
    <script>
        // --- !!! Worker URL !!! ---
        const API_BASE_URL = 'https://citation-app-worker.pnbober.workers.dev';
        // --------------------------

        // --- GLOBAL STATE ---
        let currentlyEditingVehicleId = null;
        let currentlyEditingTrailerId = null;

        // --- UTILITY FUNCTIONS ---
        if (typeof window.showCustomAlert === 'undefined') { window.showCustomAlert = (msg, type) => { alert(msg); return Promise.resolve(); }; }
        if (typeof window.showCustomConfirm === 'undefined') { window.showCustomConfirm = (msg) => Promise.resolve(confirm(msg)); }
        
        function decodeJwt(token) { 
            try { return JSON.parse(atob(token.split('.')[1])); } 
            catch (e) { return null; } 
        }

        async function fetchWithAuth(url, options = {}) {
            const token = localStorage.getItem('citizenAuthToken');
            if (!token) {
                redirectToLogin("No session found. Please log in.");
                return null;
            }

            options.headers = { ...options.headers, 'Authorization': `Bearer ${token}` };
            if (options.body && typeof options.body === 'object') {
                options.headers['Content-Type'] = 'application/json';
                options.body = JSON.stringify(options.body);
            }

            try {
                const response = await fetch(API_BASE_URL + url, options);
                
                if (response.status === 401 || response.status === 403) {
                    redirectToLogin("Session expired or invalid. Please log in again.");
                    return null;
                }
                
                const responseData = await response.json().catch(() => ({})); 

                if (!response.ok) {
                    throw new Error(responseData.message || `Error ${response.status}`);
                }
                
                 if (options.method === 'POST' || options.method === 'PUT' || options.method === 'DELETE') {
                     return { success: true, message: responseData.message || "Operation successful.", data: responseData };
                 }
                
                return responseData; // Return JSON data for GET
            } catch (error) {
                console.error("API Fetch Error:", error.message);
                if (error.message.includes("already registered")) {
                    await window.showCustomAlert(error.message, "Error");
                } else {
                    await window.showCustomAlert(`API Error: ${error.message}`, "Error");
                }
                return null;
            }
        }

        function redirectToLogin(message) {
             console.warn(message);
             localStorage.removeItem('citizenAuthToken');
             // Attempt to update message even if element might not exist yet
             const welcomeMsgEl = document.getElementById('welcomeMessageDisplay');
             if (welcomeMsgEl) welcomeMsgEl.textContent = message;
             setTimeout(() => {
                window.location.href = 'citizen_login.html';
             }, 2000);
        }

        // --- DOMContentLoaded (Main Entry Point) ---
        document.addEventListener('DOMContentLoaded', () => {
            // Get all DOM elements
            const citizenUserNameDisplay = document.getElementById('citizenUserNameDisplay');
            const sidebarCitizenUsernameDisplay = document.getElementById('sidebarCitizenUsernameDisplay');
            const citizenLogoutBtn = document.getElementById('citizenLogoutBtn');
            const welcomeMessageDisplay = document.getElementById('welcomeMessageDisplay');
            const recordDiscordIdSpan = document.getElementById('recordDiscordId');
            
            // Vehicle elements
            const vehicleListDiv = document.getElementById('vehicleList');
            const noVehiclesMessage = document.getElementById('noVehiclesMessage');
            const showAddVehicleFormBtn = document.getElementById('showAddVehicleFormBtn');
            const addVehicleForm = document.getElementById('addVehicleForm');
            const cancelAddVehicleBtn = document.getElementById('cancelAddVehicleBtn');
            const addVehicleFormTitle = document.getElementById('addVehicleFormTitle');
            const addVehicleSubmitBtn = document.getElementById('addVehicleSubmitBtn');

            // Trailer elements
            const trailerListDiv = document.getElementById('trailerList');
            const noTrailersMessage = document.getElementById('noTrailersMessage');
            const showAddTrailerFormBtn = document.getElementById('showAddTrailerFormBtn');
            const addTrailerForm = document.getElementById('addTrailerForm');
            const cancelAddTrailerBtn = document.getElementById('cancelAddTrailerBtn');
            const addTrailerFormTitle = document.getElementById('addTrailerFormTitle');
            const addTrailerSubmitBtn = document.getElementById('addTrailerSubmitBtn');

            // Record elements
            const recordListDiv = document.getElementById('recordList');
            const noRecordsMessage = document.getElementById('noRecordsMessage');

            // --- 1. LOGIN & AUTHENTICATION ---
            (function handleAuthentication() {
                const params = new URLSearchParams(window.location.search);
                const token = params.get('token');

                if (token) {
                    localStorage.setItem('citizenAuthToken', token);
                    window.history.replaceState({}, document.title, window.location.pathname);
                    loadCitizenInfo(token);
                } else {
                    const existingToken = localStorage.getItem('citizenAuthToken');
                    if (existingToken) {
                        loadCitizenInfo(existingToken);
                    } else {
                        redirectToLogin('You are not logged in. Redirecting...');
                    }
                }
                
                if (citizenLogoutBtn) {
                    citizenLogoutBtn.addEventListener('click', () => {
                        redirectToLogin('Logging out...');
                    });
                }
            })();

            function loadCitizenInfo(token) {
                const payload = decodeJwt(token);
                if (payload && payload.role === 'citizen' && payload.exp * 1000 > Date.now()) {
                    
                    const displayUsername = payload.nickname || payload.username || 'Citizen';
                    const discordUsername = payload.username || 'N/A';
                    
                    const namePart = payload.nickname || payload.username;
                    const discordTagPart = payload.nickname ? payload.username : null;
                    
                    let displayHtml;

                    if (discordTagPart) {
                        // Display: Nickname [username]
                        displayHtml = `
                            ${namePart} 
                            <span class="text-sm theme-subtle-text font-normal">
                                [${discordTagPart}]
                            </span>`;
                    } else {
                        // Display: Username (raw)
                        displayHtml = namePart; 
                    }

                    // Set header welcome message (inside the <h1> tag)
                    if (welcomeMessageDisplay) {
                        welcomeMessageDisplay.innerHTML = displayHtml;
                    }
                    
                    // Set top-right display (inside the <p> tag)
                    if (citizenUserNameDisplay) {
                        citizenUserNameDisplay.innerHTML = displayHtml;
                    }

                    // Set sidebar display (inside the <p> tag)
                    if (sidebarCitizenUsernameDisplay) {
                         sidebarCitizenUsernameDisplay.innerHTML = displayHtml;
                    }
                    
                    if (recordDiscordIdSpan) recordDiscordIdSpan.textContent = payload.discordId;
                    
                    fetchMyGarageData(); // Now fetch all data
                } else {
                    redirectToLogin("Session expired or invalid. Please log in again.");
                }
            }

            // --- 2. DATA FETCHING & RENDERING ---
            
            async function fetchMyGarageData() {
                const data = await fetchWithAuth('/api/citizen/my-garage', { method: 'GET' });
                if (!data) return; 

                loadVehicleData(data.vehicles || []);
                loadTrailerData(data.trailers || []);
                loadRecordData(data.citations || [], data.arrests || []);
            }

            // --- Vehicle Functions ---
            function loadVehicleData(vehicles) {
                vehicleListDiv.innerHTML = '';
                if (vehicles.length > 0) {
                    noVehiclesMessage.classList.add('hidden');
                    vehicles.forEach(v => vehicleListDiv.appendChild(createVehicleCard(v)));
                } else {
                    noVehiclesMessage.classList.remove('hidden');
                }
            }

            function getBanLevelTextAndClass(level) {
                level = parseInt(level, 10); 
                switch (level) { 
                    case 0: return { text: '0 (None)', className: 'ban-level-0' }; 
                    case 1: return { text: '1 (Basic+)', className: 'ban-level-1' }; 
                    case 2: return { text: '2 (Standard+)', className: 'ban-level-2' }; 
                    case 3: return { text: '3 (Premium+)', className: 'ban-level-3' }; 
                    case 4: return { text: '4 (Prestige+)', className: 'ban-level-4' };
                    default: return { text: `${level === null || isNaN(level) ? 'N/A' : level} (Unknown)`, className: 'ban-level-unknown' }; 
                } 
            }

            function createVehicleCard(vehicle) {
                const div = document.createElement('div');
                div.className = 'vehicle-card';
                div.dataset.id = vehicle.id;
                const banInfo = getBanLevelTextAndClass(vehicle.ban_lvl);
                const isBanned = vehicle.ban_lvl > 0;
                div.innerHTML = `
                    <h3 class="theme-title font-semibold text-lg mb-3">Plate: <span class="font-mono theme-text-color">${vehicle.plate || 'N/A'} [${vehicle.state || 'N/A'}]</span></h3>
                    <div class="space-y-1 text-sm sm:text-base">
                        <p><span class="info-label">Brand:</span> <span class="info-value">${vehicle.brand || '--'}</span></p>
                        <p><span class="info-label">Model:</span> <span class="info-value">${vehicle.model || '--'}</span></p>
                        <p><span class="info-label">Year:</span> <span class="info-value">${vehicle.year || '--'}</span></p>
                        <p><span class="info-label">Color:</span> <span class="info-value">${vehicle.color || '--'}</span></p>
                        <p><span class="info-label">Vehicle Ban Lvl:</span> <span class="info-value font-bold ${banInfo.className}">${banInfo.text}</span></p>
                    </div>
                    <div class="mt-4 flex space-x-2">
                        <button class="btn-edit-vehicle theme-button-secondary text-xs py-1 px-2 rounded" ${isBanned ? 'disabled' : ''}>Edit Info</button>
                        <button class="btn-remove-vehicle theme-button-danger text-xs py-1 px-2 rounded">Remove</button>
                    </div>`;
                return div;
            }

            // --- Trailer Functions ---
            function loadTrailerData(trailers) {
                trailerListDiv.innerHTML = '';
                if (trailers.length > 0) {
                    noTrailersMessage.classList.add('hidden');
                    trailers.forEach(t => trailerListDiv.appendChild(createTrailerCard(t)));
                } else {
                    noTrailersMessage.classList.remove('hidden');
                }
            }

            function createTrailerCard(trailer) {
                const div = document.createElement('div');
                div.className = 'trailer-card';
                div.dataset.id = trailer.id;
                div.innerHTML = `
                    <h3 class="theme-title font-semibold text-lg mb-3">Plate: <span class="font-mono theme-text-color">${trailer.plate || 'N/A'} [${trailer.state || 'N/A'}]</span></h3>
                    <div class="space-y-1 text-sm sm:text-base">
                        <p><span class="info-label">Trailer Model:</span> <span class="info-value">${trailer.model || '--'}</span></p>
                        <p><span class="info-label">Trailer Color:</span> <span class="info-value">${trailer.color || '--'}</span></p>
                    </div>
                    <div class="mt-4 flex space-x-2">
                        <button class="btn-edit-trailer theme-button-secondary text-xs py-1 px-2 rounded">Edit Info</button>
                        <button class="btn-remove-trailer theme-button-danger text-xs py-1 px-2 rounded">Remove</button>
                    </div>`;
                return div;
            }

            // --- Record Functions ---
            function loadRecordData(citations, arrests) {
                recordListDiv.innerHTML = '';
                let totalRecords = 0;
                const allRecords = [
                    ...(citations || []).map(c => ({ ...c, recordType: 'Citation' })),
                    ...(arrests || []).map(a => ({ ...a, recordType: 'Arrest' }))
                ].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

                if (allRecords.length > 0) {
                     allRecords.forEach(record => {
                        recordListDiv.appendChild(createRecordCard(record, record.recordType));
                        totalRecords++;
                    });
                }
                noRecordsMessage.classList.toggle('hidden', totalRecords > 0);
                attachPaidCheckboxListeners(); // Attach listeners after creating cards
            }

            function createRecordCard(record, type) {
                const div = document.createElement('div');
                div.className = 'record-card relative';
                const date = new Date(record.timestamp).toLocaleDateString(); // Use LocaleDateString
                let title, details = '', amount = '', officer = '', penalCodes = '';
                const isPaid = record.paidStatus === true;
                const checkboxId = `paid-${type.toLowerCase()}-${record.id}`;

                const paidCheckboxHTML = `
                    <div class="absolute top-2 right-2 flex items-center">
                        <input type="checkbox" id="${checkboxId}" class="paid-checkbox h-4 w-4 theme-input rounded mr-1"
                               data-record-id="${record.id}" data-record-type="${type}"
                               ${isPaid ? 'checked disabled' : ''}>
                        <label for="${checkboxId}" class="text-xs ${isPaid ? 'theme-subtle-text' : 'theme-label'}">
                            ${isPaid ? 'Paid' : 'Mark Paid'}
                        </label>
                    </div>
                `;

                if (type === 'Citation') {
                    title = `Citation (#${record.id.slice(-6)})`;
                    officer = record.submittedBy || record.officerName || 'N/A';
                    amount = `Due: $${parseFloat(record.totalAmountDue || 0).toFixed(2)}`;
                    const codes = record.appliedPenalCodes || [];
                    penalCodes = codes.length > 0 ? codes.map(pc => `<code>${pc.code || 'N/A'}</code>`).join(', ') : 'N/A';
                    details = codes.length > 0 ? codes.map(pc => pc.description || 'N/A').join('; ') : (record.violationDetails || 'N/A');
                } else { // Arrest
                    title = `Arrest (#${record.id.slice(-6)})`;
                    officer = record.submittedBy || record.arrestingOfficerName || 'N/A';
                    amount = `Fines: $${parseFloat(record.totalFines || 0).toFixed(2)} | Jail: ${record.totalJailTime || 0}s`;
                    const charges = record.appliedCharges || [];
                     if (charges.length > 0) {
                        penalCodes = charges.map(c => `<code>${c.code || 'N/A'}</code>`).join(', ');
                        details = charges.map(c => c.description || 'N/A').join('; ');
                    } else {
                        penalCodes = 'N/A'; details = record.incidentDetails || 'N/A';
                    }
                }

                if (isPaid) div.classList.add('opacity-60'); // Dim if paid

                div.innerHTML = `
                    ${paidCheckboxHTML}
                    <h3 class="theme-title font-semibold text-lg mb-2 ${type === 'Arrest' ? 'text-red-500' : ''}">${title}</h3>
                    <p class="text-sm"><span class="info-label">Date:</span> <span class="info-value">${date}</span></p>
                    <p class="text-sm"><span class="info-label">Officer:</span> <span class="info-value">${officer}</span></p>
                    <p class="text-sm"><span class="info-label">Code(s):</span> <span class="info-value">${penalCodes}</span></p>
                    <p class="text-sm"><span class="info-label">Offense(s):</span> <span class="info-value">${details}</span></p>
                    <p class="text-sm"><span class="info-label">Total:</span> <span class="info-value">${amount}</span></p>
                `;
                return div;
            }

            function attachPaidCheckboxListeners() {
                const checkboxes = recordListDiv.querySelectorAll('.paid-checkbox');
                checkboxes.forEach(checkbox => {
                    checkbox.removeEventListener('change', handlePaidCheckboxChange);
                    if (!checkbox.checked) {
                         checkbox.addEventListener('change', handlePaidCheckboxChange);
                    }
                });
            }

            async function handlePaidCheckboxChange(event) {
                const checkbox = event.target;
                const recordId = checkbox.dataset.recordId;
                const recordType = checkbox.dataset.recordType; // 'Citation' or 'Arrest'

                if (!recordId || (recordType !== 'Citation' && recordType !== 'Arrest')) {
                    console.error("Invalid record type or ID for marking paid.");
                    checkbox.checked = false; return;
                }
                checkbox.disabled = true;
                const label = checkbox.nextElementSibling;
                if(label) label.textContent = 'Saving...';

                const confirmMessage = `Are you sure you want to mark this ${recordType.toLowerCase()} record as paid? This cannot be undone through the portal.`;
                const confirmed = await window.showCustomConfirm(confirmMessage, `Confirm ${recordType} Paid`);

                if (confirmed) {
                    let apiUrl = '';
                    if (recordType === 'Citation') apiUrl = `/api/citizen/citations/${recordId}/mark-paid`;
                    else apiUrl = `/api/citizen/arrests/${recordId}/mark-paid`; // Arrest endpoint

                    const result = await fetchWithAuth(apiUrl, { method: 'PUT' });

                    if (result && result.success) {
                        await window.showCustomAlert(result.message, "Success");
                        checkbox.checked = true; checkbox.disabled = true;
                        if(label) label.textContent = 'Paid';
                        checkbox.closest('.record-card')?.classList.add('opacity-60');
                    } else {
                        checkbox.checked = false; checkbox.disabled = false;
                        if(label) label.textContent = 'Mark Paid';
                    }
                } else {
                    checkbox.checked = false; checkbox.disabled = false;
                    if(label) label.textContent = 'Mark Paid';
                }
            }


            // --- 3. FORM & ACTION HANDLING ---

            // --- Vehicle Form ---
            showAddVehicleFormBtn.addEventListener('click', () => { resetVehicleForm(); addVehicleForm.classList.remove('hidden'); showAddVehicleFormBtn.classList.add('hidden'); });
            cancelAddVehicleBtn.addEventListener('click', () => { addVehicleForm.classList.add('hidden'); showAddVehicleFormBtn.classList.remove('hidden'); resetVehicleForm(); });

            function resetVehicleForm() { currentlyEditingVehicleId = null; addVehicleForm.reset(); addVehicleFormTitle.textContent = "Register New Vehicle"; addVehicleSubmitBtn.textContent = "Register Vehicle"; }

            addVehicleForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(addVehicleForm);
                const vehicleData = { brand: formData.get('brand'), model: formData.get('model'), year: parseInt(formData.get('year')), color: formData.get('color'), plateText: formData.get('plateText'), vehicleBanLvl: parseInt(formData.get('vehicleBanLvl') || 0), state: formData.get('state') };
                let result;
                if (currentlyEditingVehicleId) {
                    result = await fetchWithAuth(`/api/citizen/vehicles/${currentlyEditingVehicleId}`, { method: 'PUT', body: vehicleData });
                } else {
                    result = await fetchWithAuth('/api/citizen/vehicles', { method: 'POST', body: vehicleData });
                }
                if (result && result.success) {
                    await window.showCustomAlert(result.message, "Success");
                    addVehicleForm.classList.add('hidden'); showAddVehicleFormBtn.classList.remove('hidden'); resetVehicleForm(); fetchMyGarageData();
                }
            });

            // --- Trailer Form ---
            showAddTrailerFormBtn.addEventListener('click', () => { resetTrailerForm(); addTrailerForm.classList.remove('hidden'); showAddTrailerFormBtn.classList.add('hidden'); });
            cancelAddTrailerBtn.addEventListener('click', () => { addTrailerForm.classList.add('hidden'); showAddTrailerFormBtn.classList.remove('hidden'); resetTrailerForm(); });

            function resetTrailerForm() { currentlyEditingTrailerId = null; addTrailerForm.reset(); addTrailerFormTitle.textContent = "Register New Trailer"; addTrailerSubmitBtn.textContent = "Register Trailer"; }

            addTrailerForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(addTrailerForm);
                const trailerData = { trailerModel: formData.get('trailerModel'), trailerColor: formData.get('trailerColor'), plateText: formData.get('trailerPlate'), state: formData.get('state') };
                let result;
                if (currentlyEditingTrailerId) {
                     result = await fetchWithAuth(`/api/citizen/trailers/${currentlyEditingTrailerId}`, { method: 'PUT', body: trailerData });
                } else {
                    result = await fetchWithAuth('/api/citizen/trailers', { method: 'POST', body: trailerData });
                }
                if (result && result.success) {
                    await window.showCustomAlert(result.message, "Success");
                    addTrailerForm.classList.add('hidden'); showAddTrailerFormBtn.classList.remove('hidden'); resetTrailerForm(); fetchMyGarageData();
                }
            });

            // --- 4. CARD ACTION LISTENERS (EDIT/REMOVE) ---

            // --- Vehicle Actions ---
            vehicleListDiv.addEventListener('click', async (e) => {
                const editButton = e.target.closest('.btn-edit-vehicle');
                if (editButton) { const card = e.target.closest('.vehicle-card'); const vehicleId = card.dataset.id; await populateVehicleFormForEdit(vehicleId); }
                const removeButton = e.target.closest('.btn-remove-vehicle');
                if (removeButton) { const card = e.target.closest('.vehicle-card'); const vehicleId = card.dataset.id; await removeVehicle(vehicleId); }
            });

            async function populateVehicleFormForEdit(id) {
                const vehicle = await fetchWithAuth(`/api/citizen/vehicles/${id}`); if (!vehicle) return;
                currentlyEditingVehicleId = id;
                addVehicleForm.querySelector('#vehicleBrand').value = vehicle.brand || '';
                addVehicleForm.querySelector('#vehicleModel').value = vehicle.model || '';
                addVehicleForm.querySelector('#vehicleYear').value = vehicle.year || '';
                addVehicleForm.querySelector('#vehicleColor').value = vehicle.color || '';
                addVehicleForm.querySelector('#vehiclePlate').value = vehicle.plate || '';
                addVehicleForm.querySelector('#vehicleState').value = vehicle.state || '';
                addVehicleForm.querySelector('#vehicleBanLvl').value = vehicle.ban_lvl || 0;
                addVehicleFormTitle.textContent = "Edit Vehicle"; addVehicleSubmitBtn.textContent = "Save Changes";
                addVehicleForm.classList.remove('hidden'); showAddVehicleFormBtn.classList.add('hidden'); addVehicleForm.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }

            async function removeVehicle(id) {
                const confirmed = await window.showCustomConfirm("Are you sure you want to remove this vehicle? This cannot be undone.");
                if (confirmed) {
                    const result = await fetchWithAuth(`/api/citizen/vehicles/${id}`, { method: 'DELETE' });
                    if (result && result.success) { await window.showCustomAlert(result.message, "Success"); fetchMyGarageData(); }
                }
            }

            // --- Trailer Actions ---
            trailerListDiv.addEventListener('click', async (e) => {
                const editButton = e.target.closest('.btn-edit-trailer');
                if (editButton) { const card = e.target.closest('.trailer-card'); const trailerId = card.dataset.id; await populateTrailerFormForEdit(trailerId); }
                const removeButton = e.target.closest('.btn-remove-trailer');
                if (removeButton) { const card = e.target.closest('.trailer-card'); const trailerId = card.dataset.id; await removeTrailer(trailerId); }
            });

            async function populateTrailerFormForEdit(id) {
                const trailer = await fetchWithAuth(`/api/citizen/trailers/${id}`); if (!trailer) return;
                currentlyEditingTrailerId = id;
                addTrailerForm.querySelector('#trailerModel').value = trailer.model || '';
                addTrailerForm.querySelector('#trailerColor').value = trailer.color || '';
                addTrailerForm.querySelector('#trailerPlate').value = trailer.plate || '';
                addTrailerForm.querySelector('#trailerState').value = trailer.state || '';
                addTrailerFormTitle.textContent = "Edit Trailer"; addTrailerSubmitBtn.textContent = "Save Changes";
                addTrailerForm.classList.remove('hidden'); showAddTrailerFormBtn.classList.add('hidden'); addTrailerForm.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }

            async function removeTrailer(id) {
                const confirmed = await window.showCustomConfirm("Are you sure you want to remove this trailer? This cannot be undone.");
                if (confirmed) {
                    const result = await fetchWithAuth(`/api/citizen/trailers/${id}`, { method: 'DELETE' });
                    if (result && result.success) { await window.showCustomAlert(result.message, "Success"); fetchMyGarageData(); }
                }
            }

            // --- Sidebar/Header setup ---
            (function setupLayout() {
                 const appSidebar = document.getElementById('appSidebar'); const sidebarToggle = document.getElementById('sidebarToggle'); const appHeader = document.getElementById('appHeader'); const mainContentArea = document.getElementById('mainContentArea'); const SIDEBAR_COLLAPSED_KEY = 'sidebarCollapsed'; const isCollapsed = localStorage.getItem(SIDEBAR_COLLAPSED_KEY) === 'true'; if (isCollapsed) { appSidebar.classList.add('collapsed'); appHeader.classList.add('collapsed'); if (window.innerWidth <= 1024) mainContentArea.classList.add('collapsed'); } else { if (window.innerWidth <= 1024) mainContentArea.classList.remove('collapsed'); } function toggleSidebar() { const isCurrentlyCollapsed = appSidebar.classList.toggle('collapsed'); appHeader.classList.toggle('collapsed'); if (window.innerWidth <= 1024) mainContentArea.classList.toggle('collapsed', isCurrentlyCollapsed); localStorage.setItem(SIDEBAR_COLLAPSED_KEY, isCurrentlyCollapsed); setTimeout(syncHeaderHeight, 300); } if (sidebarToggle) sidebarToggle.addEventListener('click', toggleSidebar); let touchStartX = 0, touchEndX = 0; const swipeThreshold = 50; document.body.addEventListener('touchstart', (e) => { if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') { touchStartX = null; return; } touchStartX = e.changedTouches[0].screenX; }, { passive: true }); document.body.addEventListener('touchend', (e) => { if (touchStartX === null) return; touchEndX = e.changedTouches[0].screenX; handleSwipeGesture(); }, { passive: true }); function handleSwipeGesture() { if (window.innerWidth >= 1024) return; const deltaX = touchEndX - touchStartX; const isSidebarCollapsed = appSidebar.classList.contains('collapsed'); if (deltaX < -swipeThreshold && !isSidebarCollapsed) toggleSidebar(); else if (deltaX > swipeThreshold && isSidebarCollapsed) toggleSidebar(); touchStartX = 0; touchEndX = 0; }
                 window.syncHeaderHeight = function() { const header = document.getElementById('appHeader'); const mainContent = document.getElementById('mainContentArea'); if (!header || !mainContent) return; const height = header.offsetHeight || 0; const safePadding = height + 16; mainContent.style.paddingTop = safePadding + 'px'; document.documentElement.style.setProperty('--app-header-height', height + 'px'); }; window.addEventListener('DOMContentLoaded', async () => { syncHeaderHeight(); setTimeout(syncHeaderHeight, 250); }); window.addEventListener('resize', syncHeaderHeight);
				 window.addEventListener('resize', () => {
  const appHeader = document.getElementById('appHeader');
  const appSidebar = document.getElementById('appSidebar');
  if (!appHeader || !appSidebar) return;

  const isCollapsed = appSidebar.classList.contains('collapsed');
  if (isCollapsed) {
    appHeader.style.width = `calc(100vw - var(--sidebar-collapsed-width))`;
    appHeader.style.left = `var(--sidebar-collapsed-width)`;
  } else {
    appHeader.style.width = `calc(100vw - var(--sidebar-width))`;
    appHeader.style.left = `var(--sidebar-width)`;
  }
});

             })();

        });
    </script>
</body>
</html>
